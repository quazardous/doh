.PHONY: help
.DEFAULT_GOAL := help

# Auto-detect user IDs to avoid permission issues
export UID := $(shell id -u)
export GID := $(shell id -g)
export PROJECT_NAME := $(shell basename $(PWD) | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g')

help: ## Show this help message
	@echo "üîß Development Environment Commands"
	@echo "=================================="
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# === Environment Management ===

dev: ## Start development environment
	docker compose up -d

stop: ## Stop all containers (preserve data)
	docker compose down

restart: ## Restart all containers (preserve data)
	docker compose down && docker compose up -d

status: ## Show running containers status
	docker compose ps

logs: ## Show container logs
	docker compose logs -f

logs-%: ## Show logs for specific service (e.g. make logs-app)
	docker compose logs -f $*

# === Container Management ===

rebuild: ## üîÑ Rebuild all containers (preserve data)
	docker compose down
	docker compose build --no-cache
	docker compose up -d

rebuild-app: ## üîÑ Rebuild only app container (preserve data)
	docker compose stop app
	docker compose build --no-cache app
	docker compose up -d app

rebuild-%: ## üîÑ Rebuild specific container (e.g. make rebuild-redis)
	docker compose stop $*
	docker compose build --no-cache $*
	docker compose up -d $*

# === Shell Access ===

sh: ## Quick access to main application container shell (web service)
	docker compose exec ${APP_CONTAINER:-app} sh

shell: ## Access main application container shell (alias for sh)
	docker compose exec ${APP_CONTAINER:-app} sh

# === Linting & Code Quality ===

lint-start: ## Start linting tools container
	docker compose --profile tools up -d linter
	@echo "‚úÖ Linting tools container started"

lint-stop: ## Stop linting tools container
	docker compose stop linter
	@echo "‚úÖ Linting tools container stopped"

lint: ## Run code linting (check only, no fixes)
	@echo "üîç Running code quality checks..."
	@if docker compose ps linter | grep -q "Up"; then \
		echo "Using dedicated linter container:"; \
		$(MAKE) lint-check; \
	else \
		echo "‚ùå Linter container not running. Start it with: make lint-start"; \
	fi

lint-fix: ## Run code linting with auto-fixes
	@echo "üîß Running code linting with auto-fixes..."
	@if docker compose ps linter | grep -q "Up"; then \
		echo "Using dedicated linter container:"; \
		$(MAKE) lint-autofix; \
	else \
		echo "‚ùå Linter container not running. Start it with: make lint-start"; \
	fi

format: ## Format code (prettify/beautify)
	@echo "‚ú® Formatting code..."
	@if docker compose ps linter | grep -q "Up"; then \
		echo "Using dedicated linter container:"; \
		$(MAKE) format-code; \
	else \
		echo "‚ùå Linter container not running. Start it with: make lint-start"; \
	fi

# Stack-specific linting targets (to be customized per project)
lint-check: ## Check code style (no fixes)
	@echo "üìã Add stack-specific lint check commands here"
	@echo "Examples:"
	@echo "  Node.js: docker compose exec linter eslint src/"
	@echo "  PHP:     docker compose exec linter phpstan analyze"
	@echo "  Python:  docker compose exec linter flake8 src/"

lint-autofix: ## Auto-fix code style issues
	@echo "üîß Add stack-specific lint fix commands here"
	@echo "Examples:"
	@echo "  Node.js: docker compose exec linter eslint src/ --fix"
	@echo "  PHP:     docker compose exec linter php-cs-fixer fix src/"
	@echo "  Python:  docker compose exec linter autopep8 --in-place --recursive src/"

format-code: ## Format/prettify code
	@echo "‚ú® Add stack-specific formatting commands here"
	@echo "Examples:"
	@echo "  Node.js: docker compose exec linter prettier --write src/"
	@echo "  PHP:     docker compose exec linter php-cs-fixer fix src/ --rules=@PSR12"
	@echo "  Python:  docker compose exec linter black src/"

# === Database Management ===

clean-data: ## üî• DANGER: Reset all database data
	@echo "‚ö†Ô∏è  This will delete ALL database data!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	docker compose down
	sudo rm -rf docker-dev/data/*/
	docker compose up -d
	@echo "‚úÖ Database data reset complete"

backup-data: ## Backup database data
	@mkdir -p backups
	@tar -czf backups/db-backup-$(shell date +%Y%m%d-%H%M%S).tar.gz docker-dev/data/ 2>/dev/null || echo "No data to backup"
	@echo "‚úÖ Database backup created"

# === Setup & Validation ===

docker-env: ## Copy all *-docker template files to working files
	@echo "üìã Setting up Docker environment files from templates..."
	@for file in *-docker; do \
		if [ -f "$$file" ]; then \
			target=$${file%-docker}; \
			if [ ! -f "$$target" ]; then \
				cp "$$file" "$$target"; \
				echo "‚úÖ Created $$target from $$file"; \
			else \
				echo "‚ö†Ô∏è $$target already exists (skipped)"; \
			fi; \
		fi; \
	done
	@echo "‚úÖ Docker environment setup complete"

check-deps: ## Check if all required dependencies are installed
	@echo "üîç Checking development dependencies..."
	@command -v docker >/dev/null && echo "‚úÖ Docker" || echo "‚ùå Docker (required)"
	@command -v docker-compose >/dev/null && echo "‚úÖ docker-compose" || echo "‚ùå docker-compose (required)"
	@command -v mkcert >/dev/null && echo "‚úÖ mkcert" || echo "‚ùå mkcert (required for HTTPS)"
	@command -v curl >/dev/null && echo "‚úÖ curl" || echo "‚ùå curl (required for testing)"
	@command -v make >/dev/null && echo "‚úÖ make" || echo "‚ùå make (required)"
	@echo ""
	@echo "üí° Run 'make install-deps' to install missing dependencies"

install-deps: ## Install missing dependencies
	@echo "üì¶ Installing development dependencies..."
	@chmod +x docker-dev/scripts/install-deps.sh
	@./docker-dev/scripts/install-deps.sh
	@echo "‚úÖ Dependencies installation complete"

setup: docker-env ssl-setup ## Initial project setup
	@echo "‚úÖ Project setup complete"

ssl-setup: ## Generate SSL certificates
	@echo "üîí Setting up SSL certificates..."
	@command -v mkcert >/dev/null || (echo "‚ùå mkcert required. Install with: brew install mkcert" && exit 1)
	@mkcert -install
	@mkdir -p docker-dev/certs
	@mkcert -cert-file docker-dev/certs/localhost.pem \
	        -key-file docker-dev/certs/localhost-key.pem \
	        "*.$(PROJECT_NAME).localhost" \
	        "$(PROJECT_NAME).localhost" \
	        "localhost"
	@echo "‚úÖ SSL certificates generated"

dev-setup: docker-env ssl-setup ## Full development environment setup
	@cp docker-compose.env .env 2>/dev/null || echo "‚ö†Ô∏è .env already exists"
	@echo "‚úÖ Development environment ready"

hello-world: ## üåç Validate entire stack is working
	@echo "üåç Running Hello World validation..."
	@echo ""
	@echo "üìã Checking services..."
	@docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "üîó Testing connectivity..."
	@echo "‚Ä¢ Traefik Dashboard: http://localhost:8080"
	@curl -s -o /dev/null -w "‚Ä¢ App HTTPS: %%{http_code} - https://app.$(PROJECT_NAME).localhost\n" -k https://app.$(PROJECT_NAME).localhost || echo "‚Ä¢ App HTTPS: ‚ùå Not responding"
	@curl -s -o /dev/null -w "‚Ä¢ App HTTP: %%{http_code} - http://app.$(PROJECT_NAME).localhost\n" http://app.$(PROJECT_NAME).localhost || echo "‚Ä¢ App HTTP: ‚ùå Not responding"
	@echo ""
	@echo "üóÑÔ∏è Testing database connections..."
	@docker compose exec -T app sh -c 'echo "Database connection test from app container:"' 2>/dev/null || echo "‚Ä¢ App container: ‚ùå Not available"
	@echo ""
	@echo "üìÅ Checking data persistence..."
	@ls -la docker-dev/data/ 2>/dev/null | grep -E "mysql|postgres|mongodb|redis" || echo "‚Ä¢ Database data: ‚úÖ No data dirs (fresh install)"
	@echo ""
	@echo "üéâ Hello World validation complete!"
	@echo ""
	@echo "üöÄ Quick access URLs:"
	@echo "   ‚Ä¢ App: https://app.$(PROJECT_NAME).localhost"
	@echo "   ‚Ä¢ Traefik: http://localhost:8080"
	@if docker compose ps | grep -q phpmyadmin; then echo "   ‚Ä¢ phpMyAdmin: https://phpmyadmin.$(PROJECT_NAME).localhost"; fi
	@if docker compose ps | grep -q adminer; then echo "   ‚Ä¢ Adminer: https://adminer.$(PROJECT_NAME).localhost"; fi
	@if docker compose ps | grep -q mongo-express; then echo "   ‚Ä¢ Mongo Express: https://mongo-express.$(PROJECT_NAME).localhost"; fi
	@if docker compose ps | grep -q mailhog; then echo "   ‚Ä¢ MailHog: https://mailhog.$(PROJECT_NAME).localhost"; fi

# === Maintenance ===

clean: ## Clean up containers and volumes
	docker compose down -v
	docker system prune -f

clean-all: ## üî• DANGER: Complete cleanup (containers + data + images)
	@echo "‚ö†Ô∏è  This will delete EVERYTHING (containers, data, images)!"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	docker compose down -v
	sudo rm -rf docker-dev/data/* docker-dev/logs/*
	docker system prune -af
	@echo "‚úÖ Complete cleanup finished"

update: ## Update all container images
	docker compose pull
	$(MAKE) rebuild
	@echo "‚úÖ All containers updated"