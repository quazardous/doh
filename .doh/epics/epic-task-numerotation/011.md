---
name: Create comprehensive DOH data model and internal structure documentation
status: completed
created: 2025-08-31T20:15:00Z
updated: 2025-08-31T19:15:00Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 002, 003, 004, 005]
parallel: true
conflicts_with: []
---

# Task: Create comprehensive DOH API documentation for data access and manipulation

## Description

Create a central reference guide for DOH command authors to understand how to properly manipulate internal DOH data. This documentation will serve as the authoritative source for command `.md` files to reference when they need to access, modify, or create DOH internal data structures.

**Primary Goal**: Eliminate ad-hoc data manipulation in commands by providing clear, standardized patterns and library functions.

**Secondary Goal**: Identify and catalog redundancy, legacy patterns, and bad practices across the DOH system for cleanup and consolidation.

## Acceptance Criteria

- [ ] Central reference guide created for command authors (`doh-data-api.md`)
- [ ] Complete "How To" guide for all DOH internal data manipulation tasks
- [ ] Library function reference with usage examples for each data operation  
- [ ] Standard patterns documented for common command operations
- [ ] "Don't Do This" examples showing deprecated/wrong approaches
- [ ] Quick lookup tables for finding the right function for each task
- [ ] **Redundancy audit**: Duplicate functions across libraries identified
- [ ] **Legacy pattern catalog**: Bad practices and deprecated approaches documented
- [ ] **Cleanup recommendations**: Specific actions to consolidate and modernize
- [ ] Command template showing proper data manipulation structure

## Documentation Scope

### **Data Structures to Document:**

#### **1. Numbering Systems**
- **Task Numbers**: Format, sequence, scope (001, 002, 003...)
- **Epic Numbers**: Format, relationship to tasks  
- **Issue Numbers**: GitHub integration, mapping to internal numbers
- **Legacy numbering**: Old schemes, migration status
- **Number conflicts**: How duplicates are detected and resolved

#### **2. File Structures**
- **Directory hierarchy**: `.doh/epics/`, `.doh/prds/`, etc.
- **File naming**: `001.md`, `epic.md`, `progress.md`
- **Path patterns**: How files are located and organized
- **Cache files**: `.doh/projects/{id}/registers.json`, etc.

#### **3. Frontmatter Schemas**
- **Task frontmatter**: Required/optional fields, formats, validation rules
- **Epic frontmatter**: Structure, progress tracking, relationships
- **PRD frontmatter**: Document metadata, versioning
- **Status values**: open/closed/completed/in-progress/blocked
- **Relationship fields**: depends_on, conflicts_with, parallel

#### **4. Internal Data Formats**
- **Registry JSON**: `~/.doh/projects/{id}/registers.json` structure
- **Cache formats**: File cache, graph cache JSON schemas
- **Queue messages**: Message queue data format
- **Progress tracking**: How completion percentages are calculated
- **Relationships**: Parent/child, dependencies, conflicts data model

#### **5. Data Flow Patterns**
- **Task creation flow**: Number assignment ‚Üí File creation ‚Üí Registry update ‚Üí Cache refresh
- **Status changes**: Frontmatter update ‚Üí Progress calculation ‚Üí Epic update ‚Üí GitHub sync
- **Epic decomposition**: PRD ‚Üí Tasks ‚Üí Numbering ‚Üí File structure
- **Cross-system sync**: DOH internal ‚Üî GitHub issues ‚Üî Local files

#### **6. Legacy Data Formats & Redundancy Audit**
- **Pre-numbering system**: How old tasks were organized
- **Manual numbering**: Ad-hoc schemes before centralized system  
- **Duplicate functions**: Same functionality implemented in multiple places
- **Redundant patterns**: Commands doing the same thing differently
- **Dead code**: Unused functions and deprecated patterns
- **Migration opportunities**: What can be consolidated or modernized

## Technical Details

### Documentation Structure:

```markdown
# DOH Data Manipulation Guide for Command Authors

## Quick Lookup: "I need to..."

| **I need to...** | **Use this function** | **Library** |
|------------------|----------------------|-------------|
| Find a task by number | `find_file_by_number("006")` | file-cache.sh |
| Update task status | `update_frontmatter_field(file, "status", "closed")` | frontmatter.sh |
| Get next task number | `get_next_number("task", project_id)` | numbering.sh |
| Calculate epic progress | `calculate_epic_progress("epic-name")` | task.sh |
| Create new task | `create_numbered_task(epic, title, description)` | doh-numbering.sh |

## Command Patterns

### Pattern: Close a Task
```bash
# DON'T DO THIS (manual manipulation):
sed -i "s/status: open/status: closed/" "$task_file"

# DO THIS (use library functions):
source .claude/scripts/doh/lib/file-cache.sh
source .claude/scripts/doh/lib/frontmatter.sh
source .claude/scripts/doh/lib/task.sh

task_file=$(find_file_by_number "$task_number")
update_frontmatter_field "$task_file" "status" "closed"
update_frontmatter_field "$task_file" "updated" "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
epic_progress=$(calculate_epic_progress "$epic_name")
```

### Pattern: Create New Task
```bash
# DON'T DO THIS:
mkdir -p ".doh/epics/$epic_name"
echo "manual frontmatter" > ".doh/epics/$epic_name/005.md"

# DO THIS:
source .claude/scripts/doh/lib/doh-numbering.sh
create_numbered_task "$epic_name" "$task_title" "$task_description"
```

## Redundancy & Legacy Issues Found

### üö® Duplicate Functions
| **Function** | **Found In** | **Status** | **Action** |
|-------------|-------------|-----------|-----------|
| File finding | Multiple commands do manual search | Redundant | Use `find_file_by_number()` |
| Status updates | Each command implements own logic | Redundant | Use `update_frontmatter_field()` |
| Progress calculation | Manual counting in 6+ commands | Redundant | Use `calculate_epic_progress()` |

### üèõÔ∏è Legacy Patterns to Eliminate
| **Pattern** | **Found In** | **Replacement** |
|-------------|-------------|-----------------|
| `sed` frontmatter editing | epic-sync, others | `frontmatter.sh` functions |
| Manual file discovery | All issue-* commands | `file-cache.sh` functions |
| Ad-hoc numbering | PRD parsing, epic decompose | `numbering.sh` system |

### üßπ Cleanup Recommendations
1. **Consolidate file discovery** - Replace 15+ manual search patterns
2. **Standardize frontmatter** - Eliminate 8+ manual YAML manipulations  
3. **Centralize progress calculation** - Remove duplicate logic in 6 commands
4. **Deprecate legacy numbering** - Migrate remaining ad-hoc schemes
```

### Command Template:
```markdown
## Standard Command Structure

### 1. Load Required Libraries
```bash
# Always load libraries at the start
source .claude/scripts/doh/lib/file-cache.sh
source .claude/scripts/doh/lib/frontmatter.sh
source .claude/scripts/doh/lib/task.sh
```

### 2. Find/Validate Data
```bash
# Use library functions for discovery
task_file=$(find_file_by_number "$ARGUMENTS")
if [[ -z "$task_file" ]]; then
    echo "‚ùå Task $ARGUMENTS not found"
    exit 1
fi
```

### 3. Manipulate Data
```bash
# Use library functions for all changes
update_frontmatter_field "$task_file" "status" "new-status"
```

### 4. Update Related Data
```bash
# Recalculate dependent data
epic_progress=$(calculate_epic_progress "$epic_name")
```
```

## Placement Decision

### Options for Documentation Location:

1. **`.claude/rules/doh-api.md`** - API reference as rules
2. **`.claude/docs/doh-api.md`** - Dedicated docs directory  
3. **`.claude/scripts/doh/README.md`** - Co-located with scripts
4. **Multiple files** - Separate file per library

### Recommendation: 
Place in **`.claude/rules/doh-api.md`** so it's part of the rules system and agents will reference it automatically.

## Dependencies

This task depends on tasks 001-005 which provide the library functions to document:
- **Task 001**: Core numbering library
- **Task 002**: File and graph caching  
- **Task 003**: Migration tools
- **Task 004**: Message queue system
- **Task 005**: Queue management commands

## Effort Estimate

**Size**: L (Large)  
**Hours**: 16-20 hours

### Breakdown:
- Library function inventory and analysis: 6 hours
- API documentation writing with examples: 8 hours  
- Legacy pattern identification and comparison: 3 hours
- Cross-referencing with existing commands: 2 hours
- Review and validation: 1 hour

## Definition of Done

- [ ] Complete API reference document created
- [ ] All library functions documented with examples
- [ ] Legacy vs modern pattern comparisons complete
- [ ] Cross-references to commands that should use each API
- [ ] Documentation is searchable and well-organized
- [ ] Code examples are tested and functional
- [ ] Integration with existing rules/docs structure
- [ ] Peer review completed for accuracy
- [ ] Agents can successfully reference the documentation
- [ ] Clear deprecation warnings for legacy patterns

## Success Metrics

- Developers can find appropriate API functions within 2 minutes
- No new commands are created using legacy patterns
- Existing commands can be audited against the API reference
- New developers can understand the DOH system architecture
- API documentation serves as authoritative source for best practices