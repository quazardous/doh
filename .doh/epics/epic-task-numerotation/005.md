---
name: Queue management commands (status, purge, retry)
status: completed
created: 2025-08-31T16:07:07Z
updated: 2025-08-31T19:35:00Z
github: [Will be updated when synced to GitHub]
depends_on: [004]
parallel: false
conflicts_with: []
---

## Task

Implement CLI commands for managing the message queue system, providing administrators with tools to monitor, maintain, and troubleshoot queue operations.

## Description

Create a comprehensive set of queue management commands that allow users to inspect queue status, purge old messages, retry failed operations, and list queue contents. All operations are scoped to the current project context.

## Acceptance Criteria

- [ ] `/doh:queue-status` command shows queue statistics and health
- [ ] `/doh:queue-purge` command removes processed/failed messages
- [ ] `/doh:queue-retry` command reprocesses failed messages
- [ ] `/doh:queue-list` command displays queue contents
- [ ] Optional queue name parameter for targeted operations
- [ ] Project-scoped operations only (no cross-project access)
- [ ] Proper error handling and user feedback
- [ ] Commands respect user permissions and project access

## Technical Details

### Command Specifications

#### `/doh:queue-status [queue-name]`
- Display queue statistics (pending, processed, failed counts)
- Show oldest and newest message timestamps
- Display queue health indicators
- Optional filtering by queue name

#### `/doh:queue-purge [queue-name] [--older-than=DURATION] [--status=STATUS]`
- Remove processed (.json.ok) and failed (.json.error) messages
- Optional time-based filtering (e.g., --older-than=7d)
- Optional status-based filtering (--status=ok|error|all)
- Dry-run mode with --preview flag

#### `/doh:queue-retry [queue-name] [message-id]`
- Retry failed messages by converting .json.error back to .json
- Process specific message by ID or all failed messages
- Limit retry attempts to prevent infinite loops
- Log retry attempts and outcomes

#### `/doh:queue-list [queue-name] [--status=STATUS] [--limit=N]`
- List messages with timestamps, IDs, and status
- Filter by status (pending, ok, error)
- Paginated output for large queues
- JSON output option for scripting

### Implementation Details
- Project context detection from current directory
- Queue discovery and validation
- Safe file operations with proper locking
- Comprehensive logging of all operations
- Input validation and sanitization

## Dependencies

- **Task 004**: Message queue system must be implemented
- CLI framework for command registration
- File system access and locking mechanisms
- Date/time parsing for filtering operations
- Project context management

## Effort Estimate

**Medium** - 2-3 days
- Command structure and parsing: 6 hours
- Queue status and statistics: 4 hours
- Purge operations with filtering: 8 hours
- Retry mechanism and safety checks: 6 hours
- List command with pagination: 4 hours
- Testing and error handling: 6 hours

## Definition of Done

- [ ] All four queue management commands are implemented
- [ ] Commands work correctly with optional parameters
- [ ] Project scoping is enforced and tested
- [ ] Error conditions are handled gracefully
- [ ] Commands provide clear, actionable feedback
- [ ] Help documentation is available for each command
- [ ] Unit tests cover all command functionality
- [ ] Integration tests verify end-to-end workflows
- [ ] Commands respect user permissions
- [ ] Performance is acceptable for large queues