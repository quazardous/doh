---
name: Core numbering library with registry management
status: completed
created: 2025-08-31T16:07:07Z
updated: 2025-08-31T19:35:00Z
github: [Will be updated when synced to GitHub]
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Core numbering library with registry management

## Description

Develop a core numbering library that provides centralized number management for epics and tasks across the DOH project management system. This library will serve as the foundation for all numbering operations, ensuring consistent and conflict-free number assignment.

The library will be implemented in `.claude/scripts/doh/lib/numbering.sh` and will provide essential functions for number generation, registration, and validation. A centralized registry will track all assigned numbers and their associated metadata.

## Acceptance Criteria

- [ ] Core library file created at `.claude/scripts/doh/lib/numbering.sh`
- [ ] `get_next_number()` function implemented with proper number sequencing
- [ ] `register_epic()` function for epic number registration
- [ ] `register_task()` function for task number registration
- [ ] Registry file structure defined in `~/.doh/projects/{project-id}/registers.json`
- [ ] File locking mechanism implemented using `flock` for concurrent access protection
- [ ] Error handling for registry corruption and recovery scenarios
- [ ] Unit tests for all core functions
- [ ] Documentation for library usage and integration

## Technical Details

### Core Functions Required:
- `get_next_number(type, project_id)` - Generate next available number for epic/task
- `register_epic(number, path, metadata)` - Register epic in central registry
- `register_task(number, epic_number, path, metadata)` - Register task with epic association
- `validate_number(number, type, project_id)` - Validate number availability
- `get_registry_path(project_id)` - Get registry file path for project

### Registry Schema:
```json
{
  "epics": {
    "001": {
      "path": ".doh/epics/epic-name/epic.md",
      "created": "2025-08-31T16:07:07Z",
      "status": "active"
    }
  },
  "tasks": {
    "001": {
      "epic": "001",
      "path": ".doh/epics/epic-name/001.md",
      "created": "2025-08-31T16:07:07Z",
      "status": "open"
    }
  }
}
```

### File Locking Strategy:
- Use `flock` with exclusive locks for write operations
- Implement timeout and retry logic for lock acquisition
- Proper cleanup and lock release in all scenarios

## Dependencies

This task has no dependencies and must be completed first as it provides the foundation for all other numbering-related functionality.

## Effort Estimate

**Size**: L (Large)  
**Hours**: 12-16 hours

### Breakdown:
- Library design and architecture: 3 hours
- Core function implementation: 6 hours
- File locking and concurrency handling: 3 hours
- Testing and validation: 3 hours
- Documentation: 1 hour

## Definition of Done

- [ ] All acceptance criteria are met
- [ ] Code passes all unit tests
- [ ] File locking works correctly under concurrent access
- [ ] Registry operations are atomic and consistent
- [ ] Error handling covers all failure scenarios
- [ ] Documentation is complete and accurate
- [ ] Integration tests pass with existing DOH system
- [ ] Code review completed and approved