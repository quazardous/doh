---
name: Audit and fix direct frontmatter manipulation across all commands
status: open
created: 2025-08-31T20:00:00Z
updated: 2025-08-31T20:00:00Z
github: [Will be updated when synced to GitHub]
depends_on: [001, 009]
parallel: false
conflicts_with: []
---

# Task: Audit and fix direct frontmatter manipulation across all commands

## Description

Conduct a comprehensive audit of all DOH commands to identify and eliminate direct frontmatter manipulation. All commands must use the standardized `frontmatter.sh` library functions instead of manual YAML editing with sed, awk, or direct file manipulation.

This task ensures consistency, reduces errors, and centralizes frontmatter operations through the established library interface.

## Acceptance Criteria

- [x] Complete audit of all `.claude/commands/doh/*.md` files for direct frontmatter manipulation
- [ ] Complete audit of all `.claude/scripts/doh/*.sh` files for direct frontmatter manipulation
- [x] Comprehensive report of all direct manipulation instances found
- [ ] All direct manipulation replaced with `frontmatter.sh` library calls (excluding epic-sync)
- [ ] All commands use `update_frontmatter_field()` for status changes (excluding epic-sync)
- [ ] All commands use `get_frontmatter_field()` for reading frontmatter (excluding epic-sync) 
- [ ] No commands use `sed`, `awk`, or direct file editing for YAML frontmatter (excluding epic-sync)
- [ ] Integration testing confirms all commands work correctly
- [ ] Documentation updated to enforce library usage
- [ ] Epic-sync special case documented for separate handling

## Audit Scope

### Files to Audit:
1. **Command definitions**: `.claude/commands/doh/*.md`
2. **Script implementations**: `.claude/scripts/doh/*.sh` (if they exist)
3. **Library files**: `.claude/scripts/doh/lib/*.sh` (for consistency)
4. **Migration scripts**: `.claude/scripts/doh/migration/*.sh`

### Patterns to Find:
- `sed` commands manipulating YAML frontmatter
- `awk` commands manipulating frontmatter fields
- Direct file writes to frontmatter sections
- Manual YAML construction/editing
- `grep` + `sed` combinations for frontmatter updates
- Hard-coded frontmatter field updates

## Technical Details

### Search Patterns:
```bash
# Direct sed manipulation
grep -r "sed.*frontmatter\|sed.*status:\|sed.*updated:" .claude/

# Direct file editing of YAML
grep -r "echo.*---\|echo.*status:\|echo.*updated:" .claude/

# Manual frontmatter construction  
grep -r "cat.*EOF.*status\|cat.*EOF.*updated" .claude/

# Awk processing of frontmatter
grep -r "awk.*status\|awk.*updated\|awk.*frontmatter" .claude/
```

### Expected Violations:
Based on audit, violations confirmed in:
- `/doh:issue-close` - Manual YAML frontmatter specification
- `/doh:issue-reopen` - Manual YAML frontmatter specification  
- `/doh:issue-start` - Manual frontmatter updates
- `/doh:issue-edit` - Manual frontmatter updates
- `/doh:issue-sync` - Manual YAML frontmatter specification
- `/doh:epic-close` - Manual YAML frontmatter specification

### Commands Excluded (Special Cases):
- `/doh:epic-sync` - **EXCLUDED** - Special case with direct sed usage, to be addressed separately

### Required Replacements:

#### Before (Direct Manipulation):
```bash
# BAD: Direct sed editing
sed -i "s/status: open/status: completed/" "$task_file"
sed -i "s/updated: .*/updated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")/" "$task_file"

# BAD: Manual YAML construction
cat >> "$task_file" <<EOF
status: completed
updated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
EOF
```

#### After (Library Usage):
```bash
# GOOD: Use frontmatter library
source .claude/scripts/doh/lib/frontmatter.sh

update_frontmatter_field "$task_file" "status" "completed"
update_frontmatter_field "$task_file" "updated" "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
current_status=$(get_frontmatter_field "$task_file" "status")
```

## Report Format

### Audit Report Structure:
```markdown
# Frontmatter Manipulation Audit Report

## Summary
- Files audited: X
- Violations found: Y  
- Commands affected: Z
- Patterns identified: A

## Violations by Command

### /doh:issue-close
**File**: .claude/commands/doh/issue-close.md
**Lines**: 28-30
**Pattern**: `sed -i "s/status: open/status: closed/" "$task_file"`
**Fix Required**: Use `update_frontmatter_field()`

### /doh:epic-start
**File**: .claude/commands/doh/epic-start.md  
**Lines**: 45-47
**Pattern**: Direct YAML construction with cat/EOF
**Fix Required**: Use `update_frontmatter_field()`

## Recommended Fixes
[Detailed fix recommendations for each violation]

## Testing Strategy
[How to verify fixes work correctly]
```

## Dependencies

- **Task 001**: Core numbering library (provides frontmatter.sh)
- **Task 009**: Task helper commands (establishes helper usage patterns)
- Existing frontmatter.sh library functions
- All DOH command infrastructure

## Effort Estimate

**Size**: L (Large)  
**Hours**: 12-16 hours

### Breakdown:
- Comprehensive audit and pattern detection: 4 hours
- Report generation and analysis: 2 hours
- Fix implementation across all commands: 6 hours
- Integration testing and validation: 3 hours
- Documentation updates: 1 hour

## Definition of Done

- [ ] Complete audit report generated with all violations documented
- [ ] All direct frontmatter manipulation eliminated
- [ ] All commands use frontmatter.sh library functions exclusively
- [ ] Integration tests pass for all modified commands
- [ ] No grep/sed/awk patterns found for frontmatter manipulation
- [ ] Documentation updated with library usage requirements
- [ ] Code review completed for all changes
- [ ] Performance impact assessed (should be minimal)
- [ ] Rollback plan documented in case of issues