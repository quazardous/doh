---
name: Message queue system for number conflicts
status: completed
created: 2025-08-31T16:07:07Z
updated: 2025-08-31T19:35:00Z
github: [Will be updated when synced to GitHub]
depends_on: [001]
parallel: false
conflicts_with: []
---

## Task

Implement a message queue system to handle number conflicts and renumbering operations in the DOH task management system.

## Description

Create a file-based message queue system that stores renumbering operations when task number conflicts occur. The queue will be used to defer and manage renumbering operations that cannot be immediately processed.

## Acceptance Criteria

- [ ] Message queue directory structure created at `~/.doh/projects/{project-id}/queues/number_conflict/`
- [ ] Individual JSON files represent queue messages with status extensions
- [ ] Support for `.json`, `.json.ok`, and `.json.error` status files
- [ ] Message structure defined for renumbering operations
- [ ] Queue operations can be performed atomically
- [ ] Messages include all necessary data for renumbering operations
- [ ] Error handling for corrupt or invalid messages
- [ ] Queue persistence across application restarts

## Technical Details

### Queue Directory Structure
```
~/.doh/projects/{project-id}/queues/number_conflict/
├── {timestamp-uuid}.json          # Pending message
├── {timestamp-uuid}.json.ok       # Processed successfully
└── {timestamp-uuid}.json.error    # Processing failed
```

### Message Structure
```json
{
  "id": "unique-message-id",
  "timestamp": "2025-08-31T16:07:07Z",
  "operation": "renumber",
  "source": {
    "type": "task|epic",
    "id": "original-id",
    "number": 123
  },
  "target": {
    "number": 124
  },
  "reason": "conflict|gap_filling",
  "metadata": {
    "user": "username",
    "command": "/doh:task-new"
  }
}
```

### File Operations
- Atomic message creation using temp files and rename
- Status transitions: `.json` -> `.json.ok` or `.json.error`
- Cleanup of old processed messages
- Lock files to prevent concurrent processing

## Dependencies

- **Task 001**: Core numbering library must be implemented first
- File system access and atomic operations
- JSON serialization/deserialization
- UUID generation for message IDs

## Effort Estimate

**Medium** - 2-3 days
- Queue directory management: 4 hours
- Message structure and serialization: 6 hours
- Atomic file operations: 8 hours
- Error handling and edge cases: 6 hours

## Definition of Done

- [ ] Queue system can create, read, and manage messages
- [ ] Status transitions work correctly (pending -> ok/error)
- [ ] Atomic operations prevent corruption
- [ ] Message format is validated and documented
- [ ] Unit tests cover all queue operations
- [ ] Integration tests with task numbering system
- [ ] Error scenarios are handled gracefully
- [ ] Documentation updated with queue system usage