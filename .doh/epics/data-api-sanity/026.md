---
number: 026
epic: 024
title: Audit and migrate DOH commands to use API functions
status: pending
created: 2025-09-02T07:57:13Z
target_version: 0.7.0
file_version: 0.1.0
---

# Task 026: Audit and migrate DOH commands to use API functions

## Overview
Comprehensive audit of all DOH commands to identify direct file access patterns and migrate them to use API functions exclusively. This task ensures consistent data access patterns across the entire command ecosystem.

## Requirements

### 1. Command Audit Phase
Analyze all DOH commands for non-compliant patterns:

**Direct File Access Patterns to Replace:**
- `cat VERSION` → `version_get_current`
- `echo "x.y.z" > VERSION` → `version_set_current "x.y.z"`
- `grep "^status:" file.md` → `frontmatter_get_field "file.md" "status"`
- `ls .doh/epics/` → `cache_list_epics`
- `find . -name "*.md"` → `cache_find_file_by_number`
- Direct JSON parsing → Registry API functions
- Direct directory traversal → Cache API functions

**Commands to Audit:**
- `/doh:epic-new`
- `/doh:epic-refresh` 
- `/doh:epic-status`
- `/doh:task-new`
- `/doh:task-reopen`
- `/doh:task-list`
- `/doh:version-status`
- `/doh:version-bump`
- `/doh:version-new`
- `/doh:version-validate`
- `/doh:prd-new`
- `/doh:prd-parse`
- `/doh:worktree-*` commands
- `/doh:queue-*` commands
- All other commands in `.claude/commands/doh/`

### 2. Create Command-Specific Migration Tasks
For each non-compliant command found, create subtasks:
- Document current direct access patterns
- Identify required API functions
- Plan migration strategy
- Implement API function usage
- Test compliance and functionality

### 3. Library Loading Pattern Updates
Update all commands to use proper library loading:
- Source required libraries with dependency chain
- Use explicit initialization functions when needed (no automatic execution)
- Follow new no-op library pattern
- Use public API functions (`{lib_name}_` prefix)

### 4. API Function Gap Analysis
Identify missing API functions needed by commands:
- Document required functions not yet available
- Determine which library should provide each function
- Create implementation plan for missing API functions
- Ensure API coverage for all command needs

## Acceptance Criteria

### Command Compliance
- [ ] All DOH commands use API functions instead of direct file access
- [ ] No `cat`, `grep`, `ls`, `find` operations on DOH files in command code
- [ ] All frontmatter operations use `frontmatter_*` functions
- [ ] All version operations use `version_*` functions
- [ ] All registry operations use `registers_*` functions

### Library Loading Compliance
- [ ] Commands source libraries with proper dependency chain
- [ ] Commands use explicit initialization when needed
- [ ] No automatic execution triggered by library sourcing
- [ ] Commands use public API functions (`{lib_name}_` prefix)

### Functionality Preservation
- [ ] All existing command functionality preserved
- [ ] Error handling remains consistent or improves
- [ ] Performance maintained or improved
- [ ] Commands work with new library architecture

### API Coverage
- [ ] All required API functions available
- [ ] Missing functions identified and implementation planned
- [ ] API functions provide consistent error handling
- [ ] API functions abstract implementation details properly

## Implementation Strategy

### Phase 1: Audit and Categorize
1. Scan all command files for direct access patterns
2. Create inventory of non-compliant commands
3. Categorize by type of violation (file access, library loading, etc.)
4. Prioritize based on impact and complexity

### Phase 2: API Gap Analysis
1. Identify required API functions not yet available
2. Determine optimal library placement for new functions
3. Create API function specifications
4. Plan implementation order

### Phase 3: Migration Execution
1. Migrate highest-priority commands first
2. Test each command after migration
3. Create subtasks for complex migrations
4. Validate end-to-end functionality

### Phase 4: Validation and Testing
1. Run comprehensive command test suite
2. Verify API compliance across all commands
3. Test integration with new library architecture
4. Performance testing and optimization

## Command Migration Checklist

For each command, verify:
- [ ] Proper library sourcing with dependency chain
- [ ] Explicit initialization function calls when needed
- [ ] API functions used for all data access
- [ ] No direct file system operations on DOH files
- [ ] Public API functions used (no `_` prefix)
- [ ] Error handling preserved or improved
- [ ] Functionality tests pass
- [ ] Integration tests pass

## Dependencies
- Completion of Task 025 (core library refactoring)
- Understanding of DOH command architecture
- Access to all DOH commands
- Existing command test framework
- API function documentation

## Estimated Effort
4-6 days (extensive command ecosystem migration)

## Risk Mitigation
- Migrate commands incrementally
- Test each migration before proceeding
- Keep backup copies of original commands
- Document all changes for rollback if needed