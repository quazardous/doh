---
number: 025
epic: 024
title: Create core doh.sh library and implement no-op pattern
status: completed
created: 2025-09-02T07:57:13Z
target_version: 0.7.0
file_version: 0.1.0
---

# Task 025: Create core doh.sh library and implement no-op pattern

## Overview
Create the foundational `doh.sh` core library and establish the no-op sourcing pattern across all DOH libraries. This task implements the breaking architectural changes that form the foundation for library self-sufficiency.

## Requirements

### 1. Create Core doh.sh Library
- Create `.claude/scripts/doh/lib/doh.sh` as the foundational library
- Move `_find_doh_root` → `doh_project_dir` from `dohenv.sh` to `doh.sh`
- Implement source guard pattern:
  ```bash
  [[ -n "$DOH_LIB_CORE_LOADED" ]] && return 0
  DOH_LIB_CORE_LOADED=1
  ```
- Include essential core functions that other libraries depend on (all with `doh_` prefix for public API)
- Ensure `doh.sh` has zero dependencies (foundational library)

### 2. Refactor dohenv.sh to No-Op Pattern
- Remove all automatic execution from `dohenv.sh` sourcing
- Add `source .claude/scripts/doh/lib/doh.sh` at the top
- Implement source guard for `dohenv.sh`
- Provide explicit `load_doh_env` function for environment loading
- Remove `_find_doh_root` function (moved to `doh.sh` as `doh_project_dir`)

### 3. Apply No-Op Pattern to All Libraries
Update each library to be no-op when sourced:
- `numbering.sh`: Add source guards, source dependencies, no automatic execution
- `frontmatter.sh`: Add source guards, ensure no side effects
- `workspace.sh`: Add source guards, source `doh.sh`, no automatic execution  
- `version.sh`: Add source guards, source dependencies, no automatic execution
- `registers.sh`: Add source guards, source dependencies, no automatic execution
- `file-cache.sh`: Add source guards, source dependencies, no automatic execution
- `graph-cache.sh`: Add source guards, source dependencies, no automatic execution

### 4. Function Naming Convention Implementation
Apply naming standards across all updated libraries:
- **Private functions**: Prefix with `_{lib_name}_` (e.g., `_doh_internal_helper`, `_version_validate_input`)
- **Public API functions**: Prefix with `{lib_name}_` (e.g., `doh_project_dir`, `version_get_current`)
- Update function names consistently during refactoring

### 5. Library Dependency Resolution
Implement explicit dependency sourcing in each library according to matrix:
- `dohenv.sh` → sources `doh.sh`
- `numbering.sh` → sources `doh.sh`, `dohenv.sh`
- `workspace.sh` → sources `doh.sh`, `dohenv.sh`
- `version.sh` → sources `doh.sh`, `dohenv.sh`, `frontmatter.sh`
- `registers.sh` → sources `doh.sh`, `dohenv.sh`, `workspace.sh`
- `file-cache.sh` → sources `doh.sh`, `dohenv.sh`, `workspace.sh`, `registers.sh`
- `graph-cache.sh` → sources `doh.sh`, `dohenv.sh`, `workspace.sh`, `numbering.sh`, `frontmatter.sh`

## Acceptance Criteria

### Core Library Creation
- [ ] `doh.sh` created with `doh_project_dir` function
- [ ] `doh.sh` has source guard implemented
- [ ] `doh.sh` can be sourced independently without errors
- [ ] `doh_project_dir` function works correctly

### No-Op Pattern Implementation
- [ ] All libraries can be sourced without any automatic execution
- [ ] Source guards prevent duplicate loading across all libraries
- [ ] Each library sources its required dependencies explicitly
- [ ] No hidden dependencies remain

### Function Naming Compliance
- [ ] All private functions use `_{lib_name}_` prefix consistently
- [ ] All public API functions use `{lib_name}_` prefix consistently
- [ ] `_find_doh_root` renamed to `doh_project_dir` in `doh.sh`

### Library Independence Testing
- [ ] Each library can be sourced in isolation
- [ ] Library sourcing produces no output or side effects
- [ ] All existing functionality preserved after refactoring
- [ ] Integration tests pass with new library structure

## Implementation Notes

### Breaking Changes
- Function `_find_doh_root` renamed to `doh_project_dir` (public API with library prefix)
- Environment loading no longer automatic when sourcing `dohenv.sh`
- All libraries require explicit dependency sourcing

### Testing Strategy
- Test each library independently after refactoring
- Verify no automatic execution occurs during sourcing
- Run existing test suite to ensure no regressions
- Test dependency chain loading works correctly

### Rollback Plan
- Keep backup copies of original library files
- Document all changes for easy reversal if needed
- Test incrementally to isolate any issues

## Dependencies
- Understanding of current DOH library architecture
- Access to all library files in `.claude/scripts/doh/lib/`
- Existing test framework for validation

## Estimated Effort
2-3 days (foundational architectural changes requiring careful testing)
