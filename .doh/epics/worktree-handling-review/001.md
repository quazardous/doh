---
name: Core Workspace Awareness System
status: completed
created: 2025-08-31T06:51:25Z
updated: 2025-08-31T11:36:00Z
github: [Will be updated when synced to GitHub]
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Core Workspace Awareness System

## Description
Create a robust workspace awareness and safety system that prevents data loss, detects broken states, and provides consistent workspace persistence. This addresses critical issues like lost work in abandoned worktrees, inconsistent mode selection, and tasks marked complete without proper verification.

## Acceptance Criteria
- [ ] Workspace state persistence via `$GLOBAL_DOH_DIR/projects/{project-id}/workspace-state.yml` with safety checksums
- [ ] Broken state detection (orphaned worktrees, uncommitted work, branch mismatches)
- [ ] Recovery system for corrupted workspaces
- [ ] Coherent task completion verification before marking tasks complete
- [ ] Safety prompts before potentially destructive operations
- [ ] Stable workspace mode selection with clear guidance rules

## Technical Details
- **Implementation approach**: Defense-in-depth safety system with state recovery
- **Key files**:
  - `.doh/env` - Environment configuration (GLOBAL_DOH_DIR, etc.)
  - `.claude/scripts/doh/lib/workspace.sh` - Complete workspace management (detection, safety, persistence)
  - `.claude/scripts/doh/lib/task.sh` - Task management (completion verification, status detection, epic/PRD logic)
  - `.claude/scripts/doh/lib/frontmatter.sh` - YAML frontmatter parsing and manipulation (extract, update, validate)
  - `$GLOBAL_DOH_DIR/projects/PROJECTS.txt` - Human-readable project ID to path mapping
  - `$GLOBAL_DOH_DIR/projects/{project-id}/workspace-state.yml` - Per-project workspace state
  - `$GLOBAL_DOH_DIR/projects/{project-id}/logs/` - Agent execution logs outside working directory
  - `$GLOBAL_DOH_DIR/projects/{project-id}/locks/` - Per-project lock coordination
- **Environment variables**:
  - `GLOBAL_DOH_DIR` - Global state directory (defaults to `~/.doh/`, configurable via `.doh/env`)
- **Safety functions needed**:
  - `check_workspace_integrity()` - Detect broken/orphaned workspaces
  - `recover_workspace()` - Attempt recovery of corrupted states
  - `verify_task_completion()` - Ensure real work done before marking complete
  - `is_task_completed()` - Standardized task completion detection
  - `get_task_status()` - Extract task status from frontmatter
- **Frontmatter functions needed**:
  - `extract_frontmatter()` - Extract YAML frontmatter from markdown files
  - `get_frontmatter_field()` - Get specific field value from frontmatter
  - `update_frontmatter_field()` - Update specific field in frontmatter
  - `validate_frontmatter()` - Validate required fields are present
  - `list_epic_tasks()` - Get all tasks for an epic
  - `calculate_epic_progress()` - Calculate completion percentage
  - `choose_workspace_mode()` - Stable mode selection with consistent rules
  - `safety_prompt()` - User confirmation before risky operations
- **Multi-agent coordination functions**:
  - `acquire_workspace_lock()` - Atomic file locking for state changes
  - `register_agent()` - Register agent PID with heartbeat
  - `check_agent_conflicts()` - Detect concurrent access to same workspace
  - `cleanup_dead_agents()` - Remove stale locks from crashed agents
  - `coordinate_workspace_access()` - Ensure exclusive workspace operations
- **Auto-project detection functions**:
  - `get_current_project_id()` - Auto-detect project ID from current directory
  - `register_project_mapping()` - Add/update project ID to PROJECTS.txt
  - `lookup_project_path()` - Find path from project ID in PROJECTS.txt
  - `ensure_project_state_dir()` - Create project-specific state directory
  - `get_project_workspace_dir()` - Get isolated workspace directory for current project
  - `cleanup_project_state()` - Clean state for current project only
  - `detect_project_workspace_conflicts()` - Check for conflicts within current project scope
- **State management**:
  - Global state directory `$GLOBAL_DOH_DIR` (defaults to `~/.doh/`) outside any repository
  - Automatic project detection based on current working directory
  - Per-project state isolation using directory-based identification
  - Project-centric state storage: `$GLOBAL_DOH_DIR/projects/{project-id}/`
  - Atomic workspace persistence with file locking per project
  - Multi-agent coordination via per-project lock files and PIDs
  - Detection of uncommitted work in abandoned worktrees within project scope
  - Recovery of orphaned git worktrees with automatic project attribution
  - Per-project audit trail and agent logging outside working directories
- **Library architecture**:
  - `dohenv.sh` should only be sourced by shell scripts, not other libraries
  - Libraries expect DOH environment variables to be pre-loaded by calling script
  - Clean separation between environment loading and business logic
- **Multi-agent safety**:
  - File locking for workspace-state.yml operations
  - Agent registration system with heartbeat monitoring
  - Exclusive workspace access coordination
  - Dead agent cleanup and workspace recovery
  - Conflict detection between concurrent agents

## Dependencies
- [ ] No task dependencies (this is the foundation)
- [ ] Requires bash 4.0+ for associative arrays
- [ ] Git 2.5+ for worktree commands

## Effort Estimate
- Size: XL
- Hours: 24 hours
- Parallel: false

## New Commands to Create
- `/doh:workspace` - Show workspace diagnostic (default behavior)
- `/doh:workspace --reset` - Reset workspace to clean state when corrupted

## Definition of Done
- [ ] Safety system prevents data loss scenarios
- [ ] Broken workspace detection and recovery works
- [ ] Task completion verification prevents false "OK" marking
- [ ] Workspace state persistence with integrity checks
- [ ] Stable mode selection rules eliminate randomness
- [ ] Safety prompts protect against destructive operations
- [ ] **Multi-agent coordination prevents race conditions**
- [ ] **File locking ensures atomic state operations**
- [ ] **Agent registration and heartbeat monitoring works**
- [ ] **Dead agent cleanup and lock recovery functions**
- [ ] **Concurrent workspace access coordination**
- [ ] **workspace-reset command implemented and tested**
- [ ] Comprehensive testing with broken state scenarios
- [ ] Audit trail captures all workspace decisions