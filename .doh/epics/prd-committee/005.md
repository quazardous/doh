---
title: "Implement 2-round workflow orchestrator with rating collection"
status: open
priority: high
size: M
parallel: false
depends_on: [001, 002, 003, 004]
created: 2025-08-31T00:34:44Z
updated: 2025-08-31T00:34:44Z
epic: prd-committee
tags: [session-engine, workflow-orchestrator, rating-system, coordination]
---

# Implement 2-round Workflow Orchestrator with Rating Collection

## Summary

Build the core session engine that orchestrates the 2-round committee workflow: Round 1 (parallel agent drafting), collection phase (rating and feedback), Round 2 (revision based on feedback), and final rating collection. This orchestrator manages agent coordination, timing, and data flow between rounds.

## Acceptance Criteria

- [ ] Orchestrator manages complete 2-round workflow from start to finish
- [ ] Round 1: All 4 agents draft PRD sections in parallel with proper timeouts
- [ ] Collection Phase: Each agent rates and provides feedback on other agents' drafts
- [ ] Round 2: Agents revise their sections based on collected feedback
- [ ] Final rating collection with numerical scores and qualitative feedback
- [ ] Proper error handling for agent failures, timeouts, and invalid responses
- [ ] Session state persistence with complete audit trail
- [ ] Integration with existing committee framework and file structure

## Technical Requirements

### Core Orchestration Engine
- Implement session state machine with clear round transitions
- Manage parallel agent execution with configurable timeouts (default: 5 minutes per round)
- Handle agent coordination and data passing between rounds
- Implement retry logic for failed agent calls with exponential backoff

### Rating Collection System
- Design rating schema: numerical scores (1-10) + qualitative feedback
- Collect ratings from each agent on every other agent's work
- Aggregate ratings with conflict detection (variance > threshold)
- Store complete rating matrix for convergence analysis

### Session Management
- Create session files under `.claude/committees/{feature}/session.md`
- Persist intermediate drafts, ratings, and revisions
- Maintain complete audit trail with timestamps and agent IDs
- Enable session recovery after interruption or failure

### Agent Communication Protocol
- Define standardized input/output formats for agent interactions
- Implement agent-specific context preparation (domain focus, requirements)
- Handle agent response validation and error recovery
- Manage cross-agent feedback delivery and formatting

## Architecture Design

### Session State Flow
```
Initialize → Round1_Parallel → Collect_Ratings → Round2_Revisions → Final_Rating → Convergence_Check
```

### Key Classes/Components
- `SessionOrchestrator`: Main coordination engine
- `RatingCollector`: Manages rating aggregation and validation
- `AgentCoordinator`: Handles parallel agent execution
- `SessionPersistence`: File-based state management
- `TimeoutManager`: Configurable timeout handling with graceful degradation

### Rating System Specifications
- **Numerical Scores**: 1-10 scale per PRD section (vision, requirements, success criteria, etc.)
- **Qualitative Feedback**: Structured text with specific improvement suggestions
- **Conflict Detection**: Flag ratings with standard deviation > 2.5 points
- **Weighting System**: Optional agent expertise weighting (e.g., DevOps agent's security ratings weighted higher)

## Performance Requirements

- Complete 2-round process within 15 minutes total
- Support up to 8 PRD sections in parallel processing
- Handle concurrent rating collection from 4 agents simultaneously
- Graceful degradation when agents timeout (continue with available responses)
- Session recovery within 30 seconds of interruption

## Integration Points

- **Agent Framework**: Leverage existing DOH agent system and patterns
- **File System**: Follow `.claude/committees/{feature}/` structure
- **Error Handling**: Integrate with existing resilience layer
- **Command Interface**: Expose session control through `/doh:prd-committee` commands

## Edge Cases & Error Handling

### Agent Failure Scenarios
- Individual agent timeout: Continue with remaining agents, mark as degraded
- Multiple agent failures: Escalate to CTO agent for assessment
- Session interruption: Persist state and enable clean recovery
- Invalid rating responses: Request re-submission with validation feedback

### Data Consistency
- Prevent race conditions in parallel agent execution
- Ensure rating integrity with validation rules
- Handle partial session completion scenarios
- Maintain referential integrity between rounds

## Definition of Done

- Orchestrator successfully manages complete 2-round workflow
- All agent coordination works reliably with proper timeout handling
- Rating collection system captures structured feedback accurately
- Session persistence enables recovery from any interruption point
- Performance meets 15-minute total completion target
- Integration tests cover all workflow scenarios and edge cases
- Error handling gracefully manages all identified failure modes
- Code follows existing patterns and includes comprehensive logging

## Implementation Notes

- Build incrementally: basic orchestration → rating system → error handling
- Use existing DOH patterns for agent interaction and file management
- Implement extensive logging for debugging complex agent interactions
- Consider making timeout values configurable for different deployment environments
- Design for extensibility: future support for 3+ rounds or additional agent types