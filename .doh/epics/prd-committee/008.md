---
name: "Design and implement committee session file structure system"
epic: prd-committee
status: open
created: 2025-08-31T00:34:44Z
updated: 2025-08-31T00:34:44Z
parallel: true
dependencies: []
size: M
estimate: 2-3 days
---

# Task 008: Design and implement committee session file structure system

## Objective
Design and implement a comprehensive file structure system for storing committee sessions with complete audit trail, organized storage, and efficient retrieval of session data, drafts, and decision history.

## Background
The PRD committee system requires structured storage for multi-agent collaborative sessions that preserves the complete decision-making process, agent drafts, ratings, and convergence analysis. This file structure must support session recovery, audit trail requirements, and integration with existing DOH command workflows.

## Scope

### In Scope
- Design hierarchical directory structure for committee sessions
- Implement session metadata management and tracking
- Create structured storage for agent drafts and ratings
- Build convergence analysis historization system
- Design file naming conventions and organization patterns
- Implement session recovery and continuation mechanisms
- Create audit trail preservation with decision rationale
- Build integration points with existing DOH file patterns

### Out of Scope
- User interface for browsing sessions (future enhancement)
- Advanced search capabilities across session history
- Session analytics and reporting features
- Integration with external version control systems

## Technical Requirements

### File Structure Design
```
.doh/committees/{feature-name}/
├── session-{timestamp}/
│   ├── metadata.json              # Session info, agents, timing
│   ├── rounds/
│   │   ├── round-1/
│   │   │   ├── drafts/
│   │   │   │   ├── devops-draft.md
│   │   │   │   ├── lead-dev-draft.md
│   │   │   │   ├── ux-draft.md
│   │   │   │   └── po-draft.md
│   │   │   ├── ratings/
│   │   │   │   ├── devops-ratings.json
│   │   │   │   ├── lead-dev-ratings.json
│   │   │   │   ├── ux-ratings.json
│   │   │   │   └── po-ratings.json
│   │   │   └── analysis/
│   │   │       ├── convergence-metrics.json
│   │   │       └── round-summary.md
│   │   └── round-2/
│   │       ├── drafts/
│   │       ├── ratings/
│   │       └── analysis/
│   ├── final/
│   │   ├── merged-prd.md          # Final committee output
│   │   ├── decision-summary.md    # Key decisions and rationale
│   │   └── convergence-report.json # Final convergence analysis
│   └── logs/
│       ├── session.log            # Complete session execution log
│       └── errors.log             # Error tracking and recovery info
```

### Core Components to Implement

#### 1. Session Manager Class
```typescript
interface SessionManager {
  createSession(featureName: string, agents: Agent[]): SessionContext
  saveRoundDraft(sessionId: string, round: number, agent: string, draft: PRD): void
  saveRatingSet(sessionId: string, round: number, agent: string, ratings: Rating[]): void
  saveConvergenceAnalysis(sessionId: string, round: number, analysis: ConvergenceAnalysis): void
  finalizeSession(sessionId: string, finalPRD: PRD, summary: DecisionSummary): void
  recoverSession(sessionId: string): SessionContext | null
}
```

#### 2. File Operations Layer
- Atomic file write operations with backup/rollback
- Directory structure validation and automatic creation
- File locking mechanisms for concurrent session safety
- JSON schema validation for metadata and metrics files
- Markdown template system for consistent formatting

#### 3. Metadata Management
```json
{
  "sessionId": "prd-committee-20250831-003444",
  "featureName": "user-authentication",
  "status": "in-progress|completed|failed",
  "created": "2025-08-31T00:34:44Z",
  "updated": "2025-08-31T00:45:22Z",
  "agents": [
    {"role": "devops", "version": "1.0"},
    {"role": "lead-dev", "version": "1.0"},
    {"role": "ux", "version": "1.0"},
    {"role": "po", "version": "1.0"}
  ],
  "rounds": {
    "completed": 1,
    "total": 2
  },
  "convergence": {
    "round1": 0.65,
    "round2": 0.82,
    "threshold": 0.80
  }
}
```

## Implementation Details

### Phase 1: Core File Structure (Day 1)
1. **Directory Management System**
   - Create hierarchical directory creation utilities
   - Implement path validation and sanitization
   - Build session directory naming and organization
   - Add file system permissions and access control

2. **Session Metadata Framework**
   - Design metadata schema with validation
   - Implement metadata read/write operations
   - Create session ID generation and uniqueness
   - Build metadata update and versioning system

### Phase 2: Draft and Rating Storage (Day 2)
1. **Agent Draft Management**
   - Implement draft file naming conventions
   - Create markdown template system for consistent formatting
   - Build draft versioning and history tracking
   - Add draft validation and schema enforcement

2. **Rating System Storage**
   - Design rating JSON schema and validation
   - Implement rating collection and storage
   - Create rating aggregation and analysis utilities
   - Build rating history and comparison tools

### Phase 3: Analysis and Recovery (Day 3)
1. **Convergence Analysis Storage**
   - Implement convergence metrics calculation and storage
   - Create analysis report generation and formatting
   - Build convergence history tracking and trends
   - Add convergence threshold management

2. **Session Recovery System**
   - Implement session state detection and validation
   - Create recovery mechanisms for interrupted sessions
   - Build session cleanup and maintenance utilities
   - Add error handling and logging system

## Integration Points

### DOH Command Integration
- Session creation triggered by `/doh:prd-new --committee` command
- Session finalization integrated with PRD output generation
- Session history accessible through future `/doh:committee-history` command
- Error recovery integrated with existing DOH error handling

### File System Integration
- Compatible with existing `.doh/` directory structure
- Follows DOH file naming conventions and patterns
- Integrates with existing file permissions and access controls
- Maintains compatibility with DOH backup and sync systems

## Acceptance Criteria

### Functional Requirements
- [ ] Complete session directory structure created automatically
- [ ] Agent drafts stored with proper naming and formatting
- [ ] Rating data collected and stored with validation
- [ ] Convergence analysis calculated and historized
- [ ] Session recovery works for interrupted sessions
- [ ] Metadata properly tracks session state and progress
- [ ] Final PRD output integrated with existing DOH workflows
- [ ] Audit trail preserved for all decisions and changes

### Technical Requirements
- [ ] Atomic file operations prevent corruption
- [ ] JSON schema validation enforced for all structured data
- [ ] File system errors handled gracefully with recovery
- [ ] Session concurrency handled safely
- [ ] Performance acceptable for large session datasets
- [ ] Memory usage optimized for session data storage
- [ ] Integration tests pass with existing DOH components

### Quality Requirements
- [ ] Code follows existing DOH patterns and conventions
- [ ] Comprehensive error handling and logging
- [ ] Unit tests cover all core functionality
- [ ] Integration tests validate file system operations
- [ ] Documentation complete for file structure and APIs
- [ ] Performance benchmarks meet requirements

## Definition of Done
- [ ] Session file structure system implemented and tested
- [ ] Integration with DOH command system completed
- [ ] Session recovery mechanism validated
- [ ] File system operations tested for edge cases
- [ ] Documentation updated with file structure specifications
- [ ] Performance tests pass for expected session volumes
- [ ] Code review completed and approved