# T070 - Enforce Strict Linting in /doh-sys:commit with Bypass Control üîí

**Status**: COMPLETED  
**Priority**: HIGH - Code Quality & Professional Standards  
**Dependencies**: None (enhancement to existing /doh-sys:commit)  
**Epic**: E001 DOH Version 1.4.0 Release - Phase 4  
**Tags**: `#quality` `#linting` `#pipeline` `#developer-experience` `#standards`  
**Estimated Effort**: 2-3 hours  
**Created**: 2025-08-28  
**Proposed Version**: 1.4.0

## üìã Description

Implement strict linting enforcement in `/doh-sys:commit` that requires perfect markdown quality before allowing commits. The system should block commits with linting errors by default, but provide controlled bypass mechanisms for exceptional cases through user confirmation or the `--lenient` flag.

## üéØ Problem Statement

Currently, `/doh-sys:commit` allows commits to proceed even when linting fails by using `--no-verify`:

**Current Issues**:
- Linting failures result in automatic bypass with `--no-verify`
- No user control over quality standards enforcement
- Inconsistent code quality in commit history
- No differentiation between critical and minor linting issues
- Professional documentation standards not enforced

**Target Solution**:
- **Default**: Strict linting enforcement - block commits with any linting errors
- **User Choice**: Prompt for confirmation when linting fails
- **Bypass Flag**: `--lenient` flag to allow bypass without prompts
- **Intelligent Classification**: Differentiate critical vs minor issues

## Core Functionality

### 1. Strict Linting Policy (Default Behavior)

**New Default Workflow**:
```bash
/doh-sys:commit "task completed"

üîç Running pre-commit checks...
üìù Checking Markdown files...
‚ùå Markdown linting failed: 5 errors found

Critical Issues (must fix):
- todo/T070.md:45 MD047 Files should end with a single newline
- todo/T070.md:23 MD032 Lists should be surrounded by blank lines

Minor Issues (can bypass):
- todo/T070.md:120 MD013 Line length [Expected: 120; Actual: 125]

‚ùå COMMIT BLOCKED: Critical linting errors must be fixed before committing.

Options:
1. Fix issues and retry: make lint-fix
2. Use lenient mode: /doh-sys:commit "task" --lenient
3. Skip all checks: /doh-sys:commit "task" --no-lint

Run 'make lint-manual' to see detailed issue explanations.
```

### 2. Bypass Control Mechanisms

#### A. Interactive Confirmation (Default when blocked)

```bash
/doh-sys:commit "task completed"

‚ùå COMMIT BLOCKED: 5 linting errors found

‚ö†Ô∏è  BYPASS OPTIONS:
Found 5 linting errors in staged files:
- 2 critical issues (structure/syntax)  
- 3 minor issues (formatting)

Bypass linting and commit anyway? [y/N]:
> y

üö® BYPASSING LINTING - Committing with 5 unresolved issues
[main abc123d] task completed
```

#### B. Lenient Mode (--lenient)

```bash
/doh-sys:commit "task completed" --lenient

üîç Running pre-commit checks...
üìù Checking Markdown files...
‚ö†Ô∏è  Linting issues found (5 errors) - proceeding in lenient mode
[main abc123d] task completed
```

#### C. Complete Skip (--no-lint)

```bash
# Existing behavior - skip linting entirely  
/doh-sys:commit "task completed" --no-lint

‚ö° SKIPPING LINTING - No quality checks performed
[main abc123d] task completed
```

### 3. Intelligent Error Classification

**Critical Errors** (Always block unless bypassed):
- MD047: Missing final newline (breaks file parsing)
- MD025: Multiple top-level headings (structure issues)
- MD002: First heading not H1 (document hierarchy)
- MD003: Inconsistent heading style
- MD031: Code blocks not surrounded by blank lines

**Minor Errors** (Allow with warning):
- MD013: Line length violations (< 20 chars over limit)
- MD012: Multiple consecutive blank lines
- MD009: Trailing spaces
- MD040: Missing code block language (non-critical)

**Flexible Handling**:
```bash
# Only critical errors block commits
Critical: 2 errors ‚Üí BLOCK commit
Minor: 8 errors ‚Üí ALLOW with warning

# Combined: block due to critical
Critical: 1 error + Minor: 15 errors ‚Üí BLOCK commit

# No critical errors
Minor: 3 errors ‚Üí ALLOW with warning message
```

### 4. Enhanced User Experience

#### Smart Suggestions

```bash
‚ùå COMMIT BLOCKED: 3 critical linting errors found

üîß Quick Fix Suggestions:
1. Run 'make lint-fix' to auto-correct 2/3 issues
2. Manually fix: todo/T070.md line 45 (add newline at end)
3. Then retry: /doh-sys:commit "task completed"

Alternative Options:
- Use --lenient for less strict enforcement
- Use --no-lint to skip all checks (not recommended)
```

#### Progress Feedback

```bash
üîç Linting Analysis:
‚îú‚îÄ‚îÄ üìÑ Files checked: 6
‚îú‚îÄ‚îÄ ‚úÖ Perfect files: 4  
‚îú‚îÄ‚îÄ ‚ö†Ô∏è  Minor issues: 1 file (3 errors)
‚îú‚îÄ‚îÄ ‚ùå Critical issues: 1 file (2 errors)
‚îî‚îÄ‚îÄ üö´ BLOCKING: Critical errors must be resolved

üí° Tip: Run 'make lint-fix' to auto-correct formatting issues
```

## Tasks

### Phase 1: Error Classification System (1h)

- [ ] **Define error severity levels** - Critical vs Minor classification
- [ ] **Create error mapping** - Map markdownlint rules to severity levels
- [ ] **Build classification engine** - Parse linting output and categorize errors
- [ ] **Add flexible thresholds** - Allow minor error limits (e.g., max 5 minor errors)

### Phase 2: Bypass Control Implementation (1h)

- [ ] **Implement --lenient flag** - Skip interactive prompts, allow bypass with warning
- [ ] **Add interactive confirmation** - Prompt user when linting blocks commit  
- [ ] **Enhance --no-lint behavior** - Clear messaging about skipped checks
- [ ] **Create bypass logging** - Track when and why linting was bypassed

### Phase 3: User Experience Enhancement (45min)

- [ ] **Smart error reporting** - Clear distinction between critical and minor
- [ ] **Actionable suggestions** - Specific fix recommendations for each error type
- [ ] **Progress indicators** - Show linting progress and results summary
- [ ] **Help integration** - Connect to make lint-fix and lint-manual workflows

### Phase 4: Integration & Testing (15min)

- [ ] **Update existing flags** - Ensure compatibility with --split, --dry-run, etc.
- [ ] **Test error scenarios** - Verify proper blocking and bypass behavior
- [ ] **Documentation updates** - Update command help and examples
- [ ] **Backward compatibility** - Ensure no breaking changes to existing workflows

## Technical Implementation

### Enhanced Linting Pipeline

```javascript
const executeLintingPipeline = async (stagedFiles, options) => {
  if (options.noLint) {
    console.log('‚ö° SKIPPING LINTING - No quality checks performed');
    return { proceed: true, bypass: true };
  }

  console.log('üîç Running pre-commit checks...');
  const lintResults = await runMarkdownLinting(stagedFiles);
  
  if (lintResults.clean) {
    console.log('‚úÖ All files pass linting checks');
    return { proceed: true, bypass: false };
  }

  // Classify errors by severity
  const { critical, minor } = classifyLintingErrors(lintResults.errors);
  
  // Display intelligent error report
  displayLintingReport(critical, minor);
  
  // Apply bypass logic
  return applyBypassLogic(critical, minor, options);
};

const applyBypassLogic = async (critical, minor, options) => {
  // Lenient mode: allow minor errors, block critical
  if (options.lenient) {
    if (critical.length > 0) {
      console.log('‚ùå BLOCKED: Critical errors found even in lenient mode');
      return { proceed: false, reason: 'critical_errors_in_lenient' };
    } else {
      console.log('‚ö†Ô∏è  Proceeding with minor linting issues (lenient mode)');
      return { proceed: true, bypass: true };
    }
  }
  
  // Strict mode (default): block any errors unless bypassed
  if (critical.length > 0 || minor.length > 0) {
    // Interactive confirmation when blocked
    const confirmed = await promptBypassConfirmation(critical, minor);
    return { proceed: confirmed, bypass: confirmed };
  }
  
  return { proceed: true, bypass: false };
};
```

### Error Classification

```javascript
const ERROR_SEVERITY = {
  critical: [
    'MD047', // Files should end with a single newline
    'MD025', // Multiple top-level headings
    'MD002', // First heading should be a top-level heading  
    'MD031', // Fenced code blocks should be surrounded by blank lines
    'MD003'  // Heading style inconsistency
  ],
  minor: [
    'MD013', // Line length
    'MD012', // No multiple blanks
    'MD009', // No trailing spaces
    'MD040', // Fenced code language
    'MD032'  // Lists surrounded by blank lines
  ]
};

const classifyLintingErrors = (errors) => {
  const critical = errors.filter(error => 
    ERROR_SEVERITY.critical.includes(error.ruleNames[0])
  );
  const minor = errors.filter(error => 
    ERROR_SEVERITY.minor.includes(error.ruleNames[0])
  );
  
  return { critical, minor };
};
```

## Usage Examples

### Default Strict Mode

```bash
# Perfect files - proceed normally
/doh-sys:commit "completed task"
‚úÖ All files pass linting checks
[main abc123d] completed task

# Minor errors only - proceed with warning
/doh-sys:commit "completed task" 
‚ö†Ô∏è  3 minor linting issues found - proceeding with warning
[main abc123d] completed task

# Critical errors - block commit
/doh-sys:commit "completed task"
‚ùå COMMIT BLOCKED: 2 critical linting errors must be fixed
```

### Bypass Options

```bash
# Lenient mode - allow minor errors
/doh-sys:commit "completed task" --lenient
‚ö†Ô∏è  Proceeding with 5 minor linting issues (lenient mode)
[main abc123d] completed task

# Interactive confirmation when blocked
/doh-sys:commit "completed task"
‚ö†Ô∏è  Bypass linting and commit with 3 errors? [y/N]: y
üö® BYPASSING LINTING
[main abc123d] completed task

# Skip linting entirely
/doh-sys:commit "completed task" --no-lint
‚ö° SKIPPING LINTING - No quality checks performed
[main abc123d] completed task
```

### Integration with Existing Flags

```bash
# Works with all existing functionality
/doh-sys:commit --split --lenient
/doh-sys:commit "task" --dry-run  # Shows linting check results in preview
/doh-sys:commit --amend --lenient
/doh-sys:commit --split --interactive --lenient
```

## Success Criteria

- [ ] **Default strict enforcement** - Commits blocked when linting errors exist
- [ ] **Intelligent error classification** - Critical vs minor error handling
- [ ] **Multiple bypass mechanisms** - --lenient and --no-lint options with interactive prompts
- [ ] **Clear user guidance** - Actionable error messages and fix suggestions
- [ ] **Backward compatibility** - All existing flags and workflows preserved
- [ ] **Professional quality** - Documentation standards consistently enforced
- [ ] **Developer productivity** - Easy bypass for legitimate edge cases

## Benefits & Impact

- **Quality Assurance**: Enforces professional documentation standards by default
- **Flexibility**: Provides appropriate bypass mechanisms for different scenarios
- **User Experience**: Clear error reporting with actionable fix suggestions
- **Team Standards**: Consistent quality enforcement across all contributors
- **Professional Image**: Clean, well-formatted documentation in all commits
- **Productivity Balance**: Strict by default, flexible when needed

## Integration Points

- **Enhances**: Existing /doh-sys:commit pipeline with quality enforcement
- **Builds on**: T065 command beautification for better error display
- **Supports**: Professional DOH 1.4.0 release quality standards
- **Enables**: Consistent documentation quality across all DOH projects

## Implementation Notes

**Philosophy**: "Strict by default, flexible when justified"

**User Control**: Always provide escape hatches but make quality the path of least resistance.

**Error Handling**: Differentiate between structural issues (critical) and formatting preferences (minor).

**Backward Compatibility**: No breaking changes - existing workflows continue to work.

---

This enhancement transforms /doh-sys:commit from a permissive tool into a quality-enforcing pipeline while maintaining developer productivity and flexibility for exceptional cases.