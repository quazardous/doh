### T032 - Design DOH Runtime Build Process (.claude/doh/ as build directory)

**Status**: ACTIVE - Ready for implementation  
**Priority**: Medium - Build system architecture  
**Dependencies**: T031 (architecture decision)  
**Proposed Version**: 1.4.0

Design and implement build process for DOH runtime where `.claude/doh/` contains all runtime components.

**Impact**: Architecture updated - `.claude/doh/` now contains the single source of truth for skel/ and templates/ (no
duplication in project root). Build process focuses on inclaude.md generation from docs/ and maintaining runtime
integrity.

#### Critical Focus: Stable inclaude.md Generation Strategy

For stable version-to-version builds with clean diffs:

**inclaude.md Generation Process**:

1. **Source Analysis**: Read current inclaude.md structure and style
2. **Documentation Mining**: Extract updates from docs/commands.md, docs/architecture.md, WORKFLOW.md
3. **Template Consistency**: Maintain existing sections and formatting patterns
4. **Stable Output**: Ensure deterministic generation (no timestamps, consistent ordering)
5. **Diff Optimization**: Only modify sections that actually changed

**Key Sources for inclaude.md**:

- `docs/commands.md` - Command specifications and natural language usage
- `docs/architecture.md` - Structure, IDs, file organization
- `WORKFLOW.md` - Quick workflow examples
- `.claude/doh/scripts/` - Available runtime commands
- `.claude/commands/` - Claude command implementations and behavior
- `templates/` - Template structure information

**Generation Strategy**:

- Parse existing inclaude.md sections as stable baseline
- Identify which docs sections map to which inclaude.md sections
- Update only changed content, preserve structure and style
- Maintain 2KB optimization target for Claude performance
- Validate generated content matches expected format

**Enhanced Design Questions**:

1. What triggers builds? (version changes, manual, CI/CD)
2. How to validate runtime artifact quality?
3. Should `.claude/doh/` be git-ignored as build output?
4. How to maintain backward compatibility during builds?
5. Which components have been most useful for creating inclaude.md historically?
6. How to ensure deterministic, diff-friendly generation of inclaude.md?

**Revised Architecture Model**:

```text
# Documentation Sources (Project Root)
./docs/                    # Documentation only
./analysis/                # Analysis documents only

# Runtime & Development (.claude/doh/)
.claude/doh/
‚îú‚îÄ‚îÄ scripts/               # Runtime scripts (100% bash)
‚îú‚îÄ‚îÄ skel/                  # Skeleton files (single source)
‚îú‚îÄ‚îÄ templates/             # Template files (single source)
‚îú‚îÄ‚îÄ inclaude.md           # Generated runtime guide
‚îî‚îÄ‚îÄ .claude/commands/doh/ # Command implementations
```

**Simplified Build Process**:

1. **No Duplication**: skel/ and templates/ exist only in `.claude/doh/` (single source of truth)

2. **Focus on inclaude.md Generation**:
   - Generate optimized inclaude.md from docs/ sources
   - Maintain skel/ and templates/ directly in .claude/doh/
   - No copying needed for runtime functionality

3. **Build Validation**:
   - Verify inclaude.md generation quality
   - Check skel/ integrity for /doh:init
   - Validate script functionality
   - Test command implementations

4. **Clean Operations**:
   - Regenerate inclaude.md when docs change
   - Update skel/ when skeleton changes
   - No template management needed

**Integration Points**:

**Makefile Integration**:

```makefile
build:          ## Build runtime artifacts from sources
build-clean:    ## Clean build artifacts and rebuild from sources
build-check:    ## Validate build artifacts integrity
build-lint:     ## Lint generated Markdown files in build artifacts
build-test:     ## Test runtime functionality after build
clean:          ## Clean all build artifacts (skel/, templates/ in .claude/doh/)
```

**Development Workflow**:

1. Edit source files (`./skel/config.ini`, `./templates/epic_template.md`)
2. Run `make build` to sync to runtime (copy files + any generation)
3. Run `make build-lint` to lint Claude-generated Markdown (if any)
4. Test with `/doh:init` and DOH agents using built artifacts
5. Commit source files (not build artifacts)
6. Run `make clean` to remove build artifacts if needed

**Clean Process**:

```makefile
clean:  ## Clean build artifacts safely
 @echo "üßπ Cleaning DOH build artifacts..."
 @if [ -d ".claude/doh/skel" ]; then rm -rf .claude/doh/skel && echo "‚úÖ Removed .claude/doh/skel/"; fi
 @if [ -d ".claude/doh/templates" ]; then rm -rf .claude/doh/templates && echo "‚úÖ Removed .claude/doh/templates/"; fi
 @echo "üîí Preserved: scripts/, inclaude.md"
```

**Clean Safety**:

- Only removes build artifacts (skel/, templates/)
- Preserves essential runtime (scripts/, inclaude.md)
- Validates source files exist before cleaning
- Can be run safely multiple times

**Build Linting Process**:

```makefile
build-lint:  ## Lint Claude-generated Markdown in build artifacts
 @echo "üìù Linting Claude-generated Markdown..."
 # Only lint files that are GENERATED by Claude during build, not copied files
 # Example: if inclaude.md is generated from templates
 @if [ -f ".claude/doh/inclaude.md" ] && [ -f ".claude/doh/.generated" ]; then \
  npx markdownlint .claude/doh/inclaude.md; fi
 @echo "‚úÖ Generated artifacts linted"
```

**Linting Strategy**:

- **Generated files only**: Only lint Markdown that Claude creates during build process
- **Skip copied files**: Simple cp operations don't need linting (source already linted)
- **Detection mechanism**: Use marker files or timestamps to detect generated content
- **Key use case**: If inclaude.md or other files are dynamically generated from templates
- **Smart approach**: No unnecessary linting of identical copied content

**Distribution Model**:

- Package only `.claude/doh/` directory for distribution
- Source files (`./skel/`, `./docs/`) not included in end-user packages
- Self-contained runtime with all dependencies

**Tasks**:

- [ ] **Design build system architecture**: Source ‚Üí Runtime artifact mapping (skel/, templates/)
- [ ] **Implement Makefile build targets**: build, build-clean, build-check, build-lint, build-test, clean
- [ ] **Add change detection**: Only build when sources change (timestamp/checksum based)
- [ ] **Create build validation**: Verify runtime artifacts integrity and completeness
- [ ] **Implement markdown linting**: Lint generated .md files in build artifacts (T027 integration)
- [ ] **Implement clean process**: Safe removal of build artifacts (.claude/doh/skel/, .claude/doh/templates/) with
      validation
- [ ] **Integration with dev workflow**: Seamless source ‚Üí build ‚Üí lint ‚Üí test cycle
- [ ] **Update .gitignore**: Exclude build artifacts from git (if needed)
- [ ] **Distribution packaging**: Script to package runtime-only for distribution
- [ ] **Documentation**: Build process guide for contributors (build/clean/lint commands)
- [ ] **CI/CD integration**: Automated build validation in T024 testing framework
- [ ] **Performance optimization**: Fast incremental builds with smart caching

**Build System Options to Consider**:

**Option A: Make-based**:

- ‚úÖ Universal, simple, existing Makefile integration
- ‚úÖ Familiar to developers
- ‚ùå Limited change detection

**Option B: npm scripts**:

- ‚úÖ Good change detection with tools
- ‚úÖ Rich ecosystem
- ‚ùå Adds Node.js dependency to build

**Option C: Custom bash**:

- ‚úÖ DOH-native, no external deps
- ‚úÖ Full control
- ‚ùå More implementation work

**Option D: Hybrid (Make + bash utilities)**:

- ‚úÖ Best of both worlds
- ‚úÖ Leverages existing infrastructure
- ‚úÖ Extensible

**Decision Criteria**:

- **Simplicity**: Easy for contributors to understand and use
- **Performance**: Fast incremental builds for development
- **Reliability**: Consistent build results across environments
- **Integration**: Works with existing T028 dev environment
- **Dependencies**: Minimal external tool requirements

**Deliverable**: Complete build system design and implementation that maintains Single Source of Truth while providing
reliable runtime artifacts for DOH distribution and testing.

---
