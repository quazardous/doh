# T084 - Fix /dd:commit staging area management and --staged-focused mode

**Status**: REOPENED (2025-08-28) - Algo needs improvement  
**Priority**: HIGH - Critical workflow issue  
**Dependencies**: T083 (/dd:commit consolidation)  
**Epic**: None  
**Tags**: `#critical-fix` `#workflow` `#staging-management` `#user-experience`  
**Created**: 2025-08-28  
**Completed Version**: dd-0.2.0
**Implementation Date**: 2025-08-28

## 📋 Problem Statement

**Critical Staging Area Management Issue**: The current /dd:commit behavior has inconsistent and problematic staging area handling:

### Current Problematic Behavior

#### Issue 1: --staged-focused Incomplete Processing
```bash
# User has mixed changes:
# - Staged: todo/T083.md, .claude/commands/dd/commit.md  
# - Modified (unstaged): README.md, src/utils.js, config.json

/dd:commit --split --staged-focused "T083 complete"

# Current behavior: 
# ❌ Only commits staged files
# ❌ Leaves unstaged modifications untouched
# 🚨 User ends up with "dirty" working directory
# 🚨 Subsequent git operations show remaining changes
```

#### Issue 2: Default Mode Ambiguity
```bash
# User has staged + unstaged changes
/dd:commit "fix bug"

# Current behavior is unclear:
# ❓ Does it commit only staged files?
# ❓ Does it stage all modifications first?
# ❓ What happens to untracked files?
```

### Expected Behavior ("Clean My Stage" Philosophy)

**Core Principle**: By default, /dd:commit should leave the user with a **completely clean working directory** - no staged files, no modified files, everything committed appropriately.

## 🎯 Solution Design

### New Staging Management Strategy

#### Default Mode: "Clean Working Directory"
```bash
/dd:commit "T084 fix"

# New behavior:
# 1. Auto-stage ALL modified/deleted files
# 2. Process everything in appropriate commits  
# 3. Result: Completely clean working directory
# 4. Only untracked files remain (by design)
```

#### --staged-focused: "Process Staged + Smart Extension"
```bash
/dd:commit --split --staged-focused "T084 fix"

# New behavior:
# 1. Process staged files as primary group
# 2. Auto-detect related unstaged files (smart extension)
# 3. Group remaining modifications by semantic meaning
# 4. Create additional commits for remaining changes
# 5. Result: Clean working directory, focused primary commits
```

#### --staged-only: New Flag for Current --staged-focused Behavior
```bash
/dd:commit --split --staged-only "T084 fix"

# Explicit behavior:
# 1. ONLY process currently staged files
# 2. Ignore all unstaged modifications  
# 3. Leave working directory in current state
# 4. For advanced users who want partial commits
```

## 🔄 Detailed Behavior Specification

### Mode 1: Default "Clean Working Directory"

**Staging Strategy**:
1. **Auto-stage everything**: `git add -A` (all modified, deleted, new files)
2. **Semantic grouping**: Apply split algorithm to entire change set
3. **Complete processing**: Every change gets committed appropriately
4. **Clean result**: Working directory becomes completely clean

**Example Flow**:
```bash
# Starting state:
# M  todo/T084.md (modified, staged)
# M  src/utils.js (modified, unstaged)  
#    new-file.md (untracked)
# D  old-file.md (deleted, unstaged)

/dd:commit --split "T084 complete"

# Processing:
# 1. Auto-stage: git add -A (stages everything)
# 2. Semantic split: 
#    - Commit 1: todo/T084.md (task completion)
#    - Commit 2: src/utils.js, old-file.md deletion (implementation)
#    - Commit 3: new-file.md (documentation)
# 3. Result: Completely clean working directory
```

### Mode 2: --staged-focused "Smart Extension"

**Staging Strategy**:
1. **Primary focus**: Process staged files as main semantic groups
2. **Smart extension**: Detect obviously related unstaged files
3. **Remaining grouping**: Group other modifications semantically  
4. **Complete processing**: Still processes everything, but prioritizes staged intent

**Example Flow**:
```bash
# Starting state:
# M  todo/T084.md (staged - primary focus)
# M  .claude/commands/dd/commit.md (staged - primary focus)
# M  src/utils.js (unstaged - might be related)
# M  README.md (unstaged - different concern)
# M  tests/commit.test.js (unstaged - related to commit.md)

/dd:commit --split --staged-focused "T084 complete"

# Processing:
# 1. Primary commits (staged files + smart extensions):
#    - Commit 1: todo/T084.md (task completion)
#    - Commit 2: .claude/commands/dd/commit.md + tests/commit.test.js (command + tests)
# 2. Secondary commits (remaining modifications):
#    - Commit 3: src/utils.js (implementation)
#    - Commit 4: README.md (documentation)
# 3. Result: Clean working directory, staged files got priority treatment
```

### Mode 3: --staged-only "Explicit Partial" (New)

**Staging Strategy**:
1. **Explicit limitation**: Only process currently staged files
2. **No auto-staging**: Ignore all unstaged modifications
3. **Partial result**: Working directory may remain "dirty"
4. **Advanced use case**: For users who explicitly want partial commits

**Example Flow**:
```bash
# Starting state:
# M  todo/T084.md (staged)
# M  src/utils.js (unstaged - will be ignored)

/dd:commit --split --staged-only "T084 partial"

# Processing:
# 1. Only staged: Process todo/T084.md
# 2. Ignore unstaged: src/utils.js remains modified
# 3. Result: Working directory still has unstaged modifications
```

## 🎯 Implementation Strategy

### Phase 1: Staging Management Logic (1.5h)

#### A. Auto-Staging Engine
- [ ] **Default behavior**: Implement `git add -A` logic for clean working directory
- [ ] **Smart extension detection**: Algorithm to detect related unstaged files
- [ ] **File relationship analysis**: Semantic grouping that considers staged priority
- [ ] **Mode switching**: Clean logic for default/staged-focused/staged-only modes

#### B. Staging Analysis  
- [ ] **Current state detection**: Analyze staged vs unstaged vs untracked
- [ ] **Relationship mapping**: Detect which unstaged files relate to staged work
- [ ] **Semantic grouping**: Enhanced algorithm that respects staging priority
- [ ] **Conflict detection**: Handle cases where auto-staging might be problematic

### Phase 2: Enhanced Split Algorithm (1.5h)

#### A. Priority-Aware Splitting
- [ ] **Staged file priority**: Ensure staged files get primary semantic treatment
- [ ] **Extension logic**: Smart addition of related unstaged files to staged commits
- [ ] **Secondary grouping**: Semantic organization of remaining modifications
- [ ] **Message generation**: Commit messages that reflect staging priority

#### B. Mode-Specific Behavior
- [ ] **Default mode**: Full auto-staging with complete cleanup
- [ ] **--staged-focused mode**: Staged priority with smart extension and complete cleanup
- [ ] **--staged-only mode**: Explicit staged-only processing (new flag)
- [ ] **Dry-run support**: Preview for all modes showing exact staging behavior

### Phase 3: User Experience Enhancement (1h)

#### A. Clear Communication
- [ ] **Staging intention display**: Show what will be staged before processing
- [ ] **Mode explanation**: Clear messaging about which mode is active
- [ ] **Preview enhancement**: Better dry-run output showing staging decisions
- [ ] **Conflict warnings**: Alert users when auto-staging might be unexpected

#### B. Safety and Validation
- [ ] **Staging validation**: Ensure auto-staging doesn't stage unwanted files
- [ ] **Mode confirmation**: Confirm staging strategy in complex scenarios
- [ ] **Rollback support**: Easy way to undo staging decisions if needed
- [ ] **Error handling**: Graceful handling of staging conflicts or issues

## 💡 User Experience Improvements

### Before (Problematic)
```bash
# Confusing and incomplete behavior:
/dd:commit --split --staged-focused "T084"
# → Only processes staged files
# → Leaves working directory dirty
# → User confused about remaining modifications
# → Inconsistent with "commit everything" expectation
```

### After (Clean and Predictable)
```bash
# Default: Clean everything
/dd:commit --split "T084"  
# → Stages and commits ALL modifications
# → Completely clean working directory
# → Predictable "everything is committed" result

# Staged-focused: Priority + cleanup
/dd:commit --split --staged-focused "T084"
# → Staged files get priority treatment
# → Related unstaged files smartly included
# → All modifications still get committed
# → Clean working directory

# Explicit partial (advanced users)
/dd:commit --split --staged-only "T084" 
# → ONLY staged files processed
# → Explicitly leaves working directory dirty
# → Clear intent for partial commits
```

## 🎯 Smart Extension Algorithm

### Relationship Detection Logic

```javascript
const detectRelatedFiles = (stagedFiles, unstagedFiles) => {
  const related = [];
  
  stagedFiles.forEach(stagedFile => {
    unstagedFiles.forEach(unstagedFile => {
      // Same directory relationship
      if (path.dirname(stagedFile) === path.dirname(unstagedFile)) {
        related.push({ unstaged: unstagedFile, reason: 'same_directory' });
      }
      
      // Test file relationship  
      if (isTestFile(unstagedFile) && getTestTarget(unstagedFile) === stagedFile) {
        related.push({ unstaged: unstagedFile, reason: 'test_file' });
      }
      
      // Configuration relationship
      if (isConfigFile(unstagedFile) && affectsComponent(stagedFile)) {
        related.push({ unstaged: unstagedFile, reason: 'config_dependency' });
      }
      
      // Documentation relationship
      if (isDocFile(unstagedFile) && documentsComponent(stagedFile)) {
        related.push({ unstaged: unstagedFile, reason: 'documentation' });
      }
    });
  });
  
  return related;
};
```

### Extension Examples

```bash
# Smart extension scenarios:

# Scenario 1: Test files
# Staged: src/commit.js
# Unstaged: tests/commit.test.js
# → Extension: Include test file in same commit

# Scenario 2: Documentation  
# Staged: .claude/commands/dd/commit.md
# Unstaged: README.md (mentions commit command)
# → Extension: Include related documentation

# Scenario 3: Configuration
# Staged: package.json (new dependency)
# Unstaged: src/config.js (uses new dependency)
# → Extension: Include configuration that uses dependency
```

## 📊 Mode Comparison Matrix

| Mode | Staged Files | Unstaged Files | Untracked Files | Result |
|------|-------------|----------------|-----------------|---------|
| **Default** | ✅ Auto-stage all | ✅ Auto-stage all | ✅ Auto-stage all | Clean directory |
| **--staged-focused** | ✅ Priority treatment | ✅ Smart extension + secondary commits | ✅ Secondary commits | Clean directory |
| **--staged-only** | ✅ Process only | ❌ Ignore | ❌ Ignore | May remain dirty |

## 🔍 Error Handling & Edge Cases

### Large Untracked Files
- **Detection**: Identify large binary files or build artifacts
- **Warning**: Alert user before auto-staging large/binary files  
- **Option**: Provide option to exclude from auto-staging
- **Safety**: Never auto-stage files that match .gitignore patterns

### Conflicting Modifications
- **Conflict detection**: Identify files with both staged and unstaged changes
- **User choice**: Allow user to decide how to handle partial staging
- **Clear messaging**: Explain the conflict and resolution options
- **Safe default**: Prefer including all changes rather than losing modifications

### Performance Considerations
- **Large repositories**: Efficient staging analysis for large change sets
- **File system limits**: Handle repositories with thousands of modified files
- **Network considerations**: Minimize git operations for remote repositories
- **Progress feedback**: Show progress for large staging operations

## 📋 Success Criteria

### Behavioral Consistency
- [ ] **Default mode**: Always results in completely clean working directory
- [ ] **Staged-focused mode**: Prioritizes staged files but still cleans everything
- [ ] **Staged-only mode**: Explicitly processes only staged files (new flag)
- [ ] **Predictable behavior**: Users know exactly what will happen in each mode

### User Experience
- [ ] **No surprises**: Clear communication about staging intentions
- [ ] **Complete workflows**: No incomplete or confusing partial results
- [ ] **Advanced control**: Power users can still do partial commits when needed
- [ ] **Error prevention**: Avoid accidental staging of unwanted files

### Technical Quality
- [ ] **Performance**: Efficient staging analysis and operations
- [ ] **Safety**: Never lose user modifications or stage inappropriate files
- [ ] **Robustness**: Handle edge cases and large repositories gracefully
- [ ] **Integration**: Seamless integration with existing /dd:commit functionality

## 💼 Deliverables

1. **Enhanced staging management system**
   - Default "clean working directory" behavior
   - Smart --staged-focused mode with extension logic
   - New --staged-only flag for explicit partial commits

2. **Improved split algorithm**
   - Priority-aware semantic grouping
   - Smart extension detection for related files
   - Enhanced commit message generation

3. **Better user communication**
   - Clear mode descriptions and behavior
   - Enhanced preview/dry-run output
   - Staging intention display and confirmation

4. **Comprehensive testing**
   - All staging scenarios and edge cases
   - Performance testing with large repositories
   - Integration testing with existing pipeline

## Estimated Effort

**Total**: 4-5 hours
- Staging Management Logic: 1.5 hours
- Enhanced Split Algorithm: 1.5 hours  
- User Experience Enhancement: 1 hour
- Testing & Validation: 1 hour

## Benefits & Impact

- **Workflow Consistency**: Predictable "clean working directory" behavior
- **User Confidence**: Clear understanding of what will be committed
- **Advanced Control**: Power users can still do partial commits when needed
- **Error Prevention**: No more accidental incomplete commits or dirty directories
- **Professional Workflow**: Clean, complete commits that follow best practices

This fix addresses a critical workflow issue that affects daily development productivity and ensures /dd:commit provides a consistently clean, predictable experience.

## ✅ Implementation Summary

**Completed**: 2025-08-28

### What Was Implemented

1. **"Clean Working Directory" Philosophy**: 
   - **Default mode**: Auto-stages all modified/deleted files (`git add -A`) for completely clean working directory
   - **--staged-focused mode**: Priority treatment for staged files + smart extension + complete cleanup  
   - **--staged-only mode**: Explicit partial commits (new flag) that only processes currently staged files

2. **Smart Extension Algorithm**:
   - **Related file detection**: Test files, documentation, configuration dependencies
   - **Semantic relationships**: Same directory, test targets, configuration dependencies
   - **Priority-aware grouping**: Staged files get primary commit treatment, extensions grouped appropriately

3. **Enhanced user communication**:
   - **Mode comparison matrix**: Clear explanation of what each mode does
   - **Auto-detection suggestions**: Smart recommendations when splitting would be beneficial
   - **Staging intention display**: Shows exactly what will be staged before processing

### Technical Deliverables

- **Enhanced staging management system**: Three distinct modes with predictable behavior
- **Smart extension detection**: Algorithm for detecting related unstaged files in --staged-focused mode
- **Updated `.claude/commands/dd/commit.md`**: Comprehensive T084 integration with staging management documentation
- **Mode comparison documentation**: Clear matrix showing behavior differences

### Critical Issues Resolved

1. **❌ Fixed incomplete --staged-focused processing**:
   - **Before**: Only processed staged files, left working directory dirty
   - **✅ After**: Smart extension + secondary commits for complete cleanup

2. **❌ Fixed default mode ambiguity**:
   - **Before**: Unclear what would be staged and committed
   - **✅ After**: Predictable "clean working directory" behavior by default

3. **✅ Added explicit partial commit control**:
   - **New**: --staged-only flag for advanced users who want partial commits
   - **Clear intent**: Explicit behavior for incomplete working directory state

### User Impact

- **Workflow consistency**: Predictable "clean working directory" behavior eliminates confusion
- **Professional workflow**: Complete commits following best practices
- **Advanced control**: Power users can still do partial commits when explicitly needed  
- **Error prevention**: No more accidental incomplete commits or dirty working directories

This implementation resolves the critical staging area management issue and provides a consistently clean, predictable commit experience that matches professional development workflow expectations.