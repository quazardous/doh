# DD109: Restructuration du Cache de Linting - Migration vers .cache/linting

**Status**: TODO  
**Priority**: MEDIUM  
**Assigned**: Claude  
**Created**: 2025-08-29  
**Type**: Refactoring  
**Depends on**: DD107 (Lint Error Cache System), DD108 (Plugin Proposals)

## Objective

Restructurer le systÃ¨me de cache de linting en dÃ©plaÃ§ant `.lint-cache/` vers `.cache/linting/` et implÃ©menter les caches
dÃ©taillÃ©s par type d'erreur prÃ©vus dans DD108.

## Problem Statement

Le cache actuel est trop simple et mal organisÃ© :

**Structure actuelle** :

```text
.lint-cache/
â””â”€â”€ error-files.txt    # Juste une liste de fichiers
```

**Structure souhaitÃ©e** (plus cohÃ©rente et dÃ©taillÃ©e) :

```text
.cache/linting/
â”œâ”€â”€ error-files.txt         # Liste des fichiers avec erreurs
â”œâ”€â”€ error-patterns.json     # Analysis dÃ©taillÃ©e par type d'erreur
â”œâ”€â”€ md040-files.txt         # Fichiers avec erreurs MD040 spÃ©cifiquement
â”œâ”€â”€ md036-files.txt         # Fichiers avec erreurs MD036
â”œâ”€â”€ md013-files.txt         # Fichiers avec erreurs MD013
â”œâ”€â”€ plugin-suggestions.json # Suggestions de plugins basÃ©es sur patterns
â””â”€â”€ statistics.json         # MÃ©triques et statistiques d'erreurs

./linting/plugins/          # Plugins de linting (tous)
â”œâ”€â”€ md040-yaml-blocks.sh    # Plugin crÃ©Ã© et actif
â”œâ”€â”€ emphasis-converter.sh   # Plugin crÃ©Ã© et actif
â”œâ”€â”€ smart-wrapper.sh.disabled # Plugin crÃ©Ã© mais dÃ©sactivÃ©
â””â”€â”€ plugin-status.json      # Ã‰tat des plugins (actif/dÃ©sactivÃ©/rejetÃ©)
```

## Solution Design

### Phase 1: Migration du Cache Existent

**Migration des chemins** :

- `.lint-cache/error-files.txt` â†’ `.cache/linting/error-files.txt`
- Mise Ã  jour des scripts : `lint-scan.sh`, `lint-progress.sh`, `lint-update-cache.sh`
- Mise Ã  jour du systÃ¨me de plugins : `plugin-proposals.sh`

### Phase 2: ImplÃ©mentation des Caches par Type

**Cache dÃ©taillÃ© par erreur** :

```json
// .cache/linting/error-patterns.json
{
  "generated": "2025-08-29T20:45:00Z",
  "total_files_analyzed": 56,
  "error_types": {
    "MD040": {
      "files_affected": 45,
      "patterns": {
        "yaml_blocks": 23,
        "shell_commands": 15,
        "json_content": 7
      }
    },
    "MD036": {
      "files_affected": 12,
      "patterns": {
        "mode_headers": 8,
        "step_headers": 4
      }
    },
    "MD013": {
      "files_affected": 8,
      "patterns": {
        "long_urls": 5,
        "command_examples": 3
      }
    }
  }
}
```

**Listes par type d'erreur** :

```text
# .cache/linting/md040-files.txt
.claude/commands/dd/next.md
.claude/commands/doh/commit.md
todo/DD099.md
...

# .cache/linting/md036-files.txt
benchmarks/results/example-results.md
todo/DD096.md
...
```

### Phase 3: Scripts de Gestion AvancÃ©e

**Nouveau script** : `scripts/lint-analyze-patterns.sh`

```bash
# Analyse dÃ©taillÃ©e des patterns d'erreurs
./scripts/lint-analyze-patterns.sh

# Output:
# ğŸ“Š Error Pattern Analysis
# â”œâ”€â”€ MD040 (missing language): 45 files
# â”‚   â”œâ”€â”€ YAML blocks: 23 files
# â”‚   â”œâ”€â”€ Shell commands: 15 files
# â”‚   â””â”€â”€ JSON content: 7 files
# â”œâ”€â”€ MD036 (emphasis as heading): 12 files
# â”‚   â”œâ”€â”€ Mode headers (**Mode X:**): 8 files
# â”‚   â””â”€â”€ Step headers (**Step N:**): 4 files
# â””â”€â”€ MD013 (line length): 8 files
#     â”œâ”€â”€ Long URLs: 5 files
#     â””â”€â”€ Command examples: 3 files
```

## Implementation Plan

### Phase 1: Migration des Chemins

- [ ] CrÃ©er structure `.cache/linting/`
- [ ] Migrer `.lint-cache/error-files.txt` vers `.cache/linting/error-files.txt`
- [ ] Mettre Ã  jour `scripts/lint-scan.sh` avec nouveaux chemins
- [ ] Mettre Ã  jour `scripts/lint-progress.sh` avec nouveaux chemins
- [ ] Mettre Ã  jour `scripts/lint-update-cache.sh` avec nouveaux chemins
- [ ] Mettre Ã  jour `dev-tools/scripts/plugin-proposals.sh` avec nouveaux chemins

### Phase 2: SystÃ¨me de Patch IA

- [ ] CrÃ©er structure `./linting/plugins.d/` pour spÃ©cifications plugins
- [ ] CrÃ©er `./linting/backups/` pour sauvegardes avant patches
- [ ] ImplÃ©menter `plugin-status.json` pour tracking des patches IA
- [ ] Ã‰tendre `/dd:lint` avec gestion des plugins IA directement
- [ ] IA suit les Ã©tapes Installation/Uninstallation du README.md
- [ ] Support copie de fichiers code (JS, Shell, Python, etc.)
- [ ] Backup automatique des fichiers installÃ©s par plugins
- [ ] CrÃ©er `scripts/lint-analyze-patterns.sh` pour analysis dÃ©taillÃ©e
- [ ] GÃ©nÃ©rer `error-patterns.json` avec patterns par type

### Phase 3: IntÃ©gration et Tests

- [ ] Tester migration avec cache existent
- [ ] VÃ©rifier compatibilitÃ© avec `/dd:lint --suggest-plugins`
- [ ] Valider gÃ©nÃ©ration des suggestions de plugins
- [ ] Nettoyer ancien rÃ©pertoire `.lint-cache/`

## Files Affected

### Scripts Ã  Modifier

- `scripts/lint-scan.sh` - Changer chemin cache
- `scripts/lint-progress.sh` - Changer chemin cache
- `scripts/lint-update-cache.sh` - Changer chemin cache
- `dev-tools/scripts/plugin-proposals.sh` - Changer chemin cache
- `dev-tools/scripts/dd-lint-wrapper.sh` - VÃ©rifier compatibilitÃ©

### Nouveaux Scripts

- `scripts/lint-analyze-patterns.sh` - Analysis dÃ©taillÃ©e des patterns
- `scripts/lint-migrate-cache.sh` - Migration automatique des anciens caches

### Structure de Cache et Plugins

```text
.cache/linting/
â”œâ”€â”€ error-files.txt           # Migration de .lint-cache/error-files.txt
â”œâ”€â”€ error-patterns.json       # Nouveau - analysis dÃ©taillÃ©e
â”œâ”€â”€ md040-files.txt           # Nouveau - fichiers MD040 seulement
â”œâ”€â”€ md036-files.txt           # Nouveau - fichiers MD036 seulement
â”œâ”€â”€ md013-files.txt           # Nouveau - fichiers MD013 seulement
â”œâ”€â”€ plugin-suggestions.json   # Nouveau - suggestions avancÃ©es
â””â”€â”€ statistics.json           # Nouveau - mÃ©triques globales

./linting/
â”œâ”€â”€ plugins.d/                     # Plugins comme spÃ©cifications
â”‚   â”œâ”€â”€ md040-yaml-blocks/
â”‚   â”‚   â”œâ”€â”€ README.md              # SpÃ©cification IA du plugin
â”‚   â”‚   â”œâ”€â”€ STATUS                 # APPLIED
â”‚   â”‚   â”œâ”€â”€ manage.sh              # Script enable/disable
â”‚   â”‚   â”œâ”€â”€ detect-yaml.js         # Code custom (permanent)
â”‚   â”‚   â””â”€â”€ markdownlint.conf      # Config fragment
â”‚   â”œâ”€â”€ emphasis-headers/
â”‚   â”‚   â”œâ”€â”€ README.md              # SpÃ©cification IA
â”‚   â”‚   â”œâ”€â”€ STATUS                 # APPLIED
â”‚   â”‚   â”œâ”€â”€ manage.sh              # Script enable/disable
â”‚   â”‚   â””â”€â”€ markdownlint.conf      # Config fragment
â”‚   â”œâ”€â”€ line-length-smart/
â”‚   â”‚   â”œâ”€â”€ README.md              # SpÃ©cification IA
â”‚   â”‚   â”œâ”€â”€ STATUS                 # REFUSED (symlinks supprimÃ©s)
â”‚   â”‚   â”œâ”€â”€ manage.sh              # Script enable/disable
â”‚   â”‚   â”œâ”€â”€ prettier.conf          # Config prettier
â”‚   â”‚   â””â”€â”€ markdownlint.conf      # Config markdownlint
â”‚   â””â”€â”€ codespell-project-dict/
â”‚       â”œâ”€â”€ README.md              # SpÃ©cification IA
â”‚       â”œâ”€â”€ STATUS                 # PROPOSED
â”‚       â”œâ”€â”€ manage.sh              # Script enable/disable
â”‚       â””â”€â”€ words.txt              # Dictionnaire (permanent)
â”œâ”€â”€ backups/                       # Backups avant application
â”‚   â”œâ”€â”€ markdownlint.json.bak-md040
â”‚   â””â”€â”€ prettier.json.bak-line-length
â””â”€â”€ plugin-status.json             # Statut global et mÃ©triques
```

**SystÃ¨me de Patch IA** :

```json
// ./linting/plugin-status.json
{
  "ai_patch_system": {
    "version": "1.0",
    "last_updated": "2025-08-29T21:45:00Z"
  },
  "plugins": {
    "md040-yaml-blocks": {
      "type": "ai_patch",
      "specification": "plugins.d/md040-yaml-blocks/README.md",
      "version": "1.2.0",
      "status": "APPLIED",
      "target_files": [".markdownlint.json"],
      "plugin_files": [".markdownlint/rules/detect-yaml.js", ".markdownlint/rules/config.json"],
      "backup_files": ["backups/markdownlint.json.bak-md040-v1.2.0"],
      "applied_at": "2025-08-29T20:45:00Z",
      "success_rate": 0.95,
      "last_validation": "2025-08-29T21:30:00Z",
      "compatibility": "markdownlint >= 0.28.0"
    },
    "emphasis-headers": {
      "type": "ai_patch",
      "specification": "plugins.d/emphasis-headers/README.md",
      "status": "APPLIED",
      "target_files": [".markdownlint.json"],
      "backup_files": ["backups/markdownlint.json.bak-emphasis"],
      "applied_at": "2025-08-29T20:50:00Z",
      "conflicts_resolved": ["MD024", "MD036"],
      "ai_merge_strategy": "intelligent_rule_combination"
    },
    "line-length-smart": {
      "type": "ai_patch",
      "specification": "plugins.d/line-length-smart/README.md",
      "status": "REFUSED",
      "reason": "Too restrictive for code examples",
      "refused_at": "2025-08-29T21:00:00Z",
      "refused_by": "human_review",
      "target_files": [".markdownlint.json", ".prettierrc"],
      "last_attempt": "2025-08-29T20:58:00Z"
    },
    "codespell-project-dict": {
      "type": "ai_patch",
      "specification": "plugins.d/codespell-project-dict/README.md",
      "status": "PROPOSED",
      "proposed_at": "2025-08-29T21:15:00Z",
      "target_files": [".codespell.txt", "pyproject.toml"],
      "estimated_entries": 23,
      "confidence": 0.87,
      "awaiting_approval": true
    }
  }
}
```

**Ã‰tats des Plugins** :

- ğŸ’¡ **PROPOSED** - Plugin suggÃ©rÃ© par analyse IA, en attente d'approbation
- âœ… **APPLIED** - Plugin appliquÃ© et actif dans les configurations
- âŒ **REFUSED** - Plugin rejetÃ© (dÃ©finitivement ou temporairement)

**Fichiers STATUS** :

```text
# ./linting/plugins.d/md040-yaml-blocks/STATUS
APPLIED
Version: 1.2.0
Applied: 2025-08-29T20:45:00Z

# ./linting/plugins.d/line-length-smart/STATUS
REFUSED
Version: 1.0.0
Too restrictive for code examples
Refused by: human_review
Refused at: 2025-08-29T21:00:00Z

# ./linting/plugins.d/codespell-project-dict/STATUS
PROPOSED
Version: 1.1.0
Confidence: 87%
Estimated impact: 23 corrections
Awaiting human approval
```

**Structure README.md avec versioning** :

````markdown
# Plugin: MD040 YAML Auto-Detection

**Version**: 1.2.0  
**Created**: 2025-08-29  
**Updated**: 2025-08-29  
**Compatibility**: markdownlint >= 0.28.0

## Description

Automatically detects YAML content in fenced code blocks and adds appropriate language specification.

## Target Configuration

- File: `.markdownlint.json`
- Rule: `MD040` (fenced-code-language)
- Custom code: `detect-yaml.js` (included in plugin)

## Required Changes

1. Add custom rule function from `detect-yaml.js`
2. Configure rule to use custom detection logic
3. Install plugin files in markdownlint custom rules directory

## Plugin Files

- **detect-yaml.js**: Custom detection algorithm (permanent)
- **markdownlint.conf**: Configuration fragment
- **manage.sh**: Enable/disable script
- **test-cases.md**: Test examples for validation

## Management Script (manage.sh)

The plugin uses symlink-based activation:

**Enable plugin:**

```bash
./manage.sh enable
# Creates symlinks:
# .markdownlint/rules/detect-yaml.js â†’ ../plugins.d/md040-yaml-blocks/detect-yaml.js
# .markdownlint/conf.d/md040-yaml.conf â†’ ../plugins.d/md040-yaml-blocks/markdownlint.conf
```
````

**Disable plugin:**

```bash
./manage.sh disable
# Removes symlinks:
# rm .markdownlint/rules/detect-yaml.js
# rm .markdownlint/conf.d/md040-yaml.conf
# Files remain in plugins.d/ but are inactive
```

**Check status:**

```bash
./manage.sh status
# ENABLED: symlinks active
# DISABLED: no symlinks found
```

## AI Integration

The AI calls the management script instead of manual file operations:

- **Apply**: `./plugins.d/md040-yaml-blocks/manage.sh enable`
- **Refuse**: `./plugins.d/md040-yaml-blocks/manage.sh disable`
- **Status**: `./plugins.d/md040-yaml-blocks/manage.sh status`

## Version History

- **1.2.0**: Added document separator pattern `---`
- **1.1.0**: Added list item detection `- item`
- **1.0.0**: Initial YAML key-value detection

## Breaking Changes

- **1.2.0**: None
- **1.1.0**: Requires markdownlint >= 0.28.0

````

## Benefits

- ğŸ—‚ï¸ **Organisation**: Structure plus logique dans `.cache/` + `./linting/plugins/`
- ğŸ¯ **SpÃ©cialisation**: Caches par type d'erreur pour traitement ciblÃ©
- ğŸ“Š **Analytics**: Patterns dÃ©taillÃ©s pour meilleure suggestion de plugins
- âš¡ **Performance**: Traitement par type sans re-scan complete
- ğŸ”§ **Maintenance**: SÃ©paration claire des responsabilitÃ©s
- ğŸ”Œ **Gestion Plugins**: Ã‰tats actif/dÃ©sactivÃ©/rejetÃ© avec mÃ©triques
- ğŸ“ˆ **Feedback**: Success rate et usage stats pour optimisation

## Success Criteria

- [ ] Migration complÃ¨te sans perte de donnÃ©es
- [ ] Tous les scripts fonctionnent avec nouveaux chemins
- [ ] Analysis par patterns fonctionne et gÃ©nÃ¨re suggestions prÃ©cises
- [ ] Performance maintenue ou amÃ©liorÃ©e
- [ ] CompatibilitÃ© avec workflow `/dd:lint` existent

## Brainstorm: Linters Analysis et IntÃ©gration

### Linters UtilisÃ©s dans le Project

**Analyse des outils actuels** pour dÃ©finir l'approche modulaire par linter :

#### 1. Markdownlint (`markdownlint-cli`)
- **Configuration**: `.markdownlint.json`
- **Erreurs communes**: MD040 (code blocks), MD036 (emphasis), MD013 (line length)
- **Plugin support**: Custom rules via `.js` files
- **Config merging**: JSON merge possible avec jq
- **Management**: `scripts/linting/manager_markdownlint_plugin.sh`

**StratÃ©gie d'intÃ©gration** :
```bash
# Structure markdownlint plugins
./linting/plugins.d/markdownlint/
â”œâ”€â”€ md040-yaml-blocks/
â”‚   â”œâ”€â”€ detect-yaml.js          # Custom rule implementation
â”‚   â”œâ”€â”€ config-fragment.json    # Rule configuration
â”‚   â””â”€â”€ README.md               # AI specification
````

#### 2. Prettier

- **Configuration**: `.prettierrc`, `.prettierignore`
- **Erreurs communes**: Code formatting, line breaks, trailing spaces
- **Plugin support**: Via plugins et configuration options
- **Config merging**: JSON/YAML merge avec options
- **Management**: `scripts/linting/manager_prettier_plugin.sh`

**StratÃ©gie d'intÃ©gration** :

```bash
# Structure prettier plugins
./linting/plugins.d/prettier/
â”œâ”€â”€ smart-line-breaks/
â”‚   â”œâ”€â”€ config-fragment.json    # Prettier options
â”‚   â””â”€â”€ README.md               # AI specification
```

#### 3. Codespell

- **Configuration**: `.codespell.cfg`, `pyproject.toml`, ou CLI args
- **Erreurs communes**: Typos, project-specific words
- **Plugin support**: Custom dictionaries, ignore files
- **Config merging**: Append to wordlists et ignore patterns
- **Management**: `scripts/linting/manager_codespell_plugin.sh`

**StratÃ©gie d'intÃ©gration** :

```bash
# Structure codespell plugins
./linting/plugins.d/codespell/
â”œâ”€â”€ project-dictionary/
â”‚   â”œâ”€â”€ words.txt               # Custom word list
â”‚   â””â”€â”€ README.md               # AI specification
```

#### 4. Scripts Shell (si utilisÃ©s)

- **Outil**: ShellCheck (`shellcheck`)
- **Configuration**: `.shellcheckrc` ou CLI options
- **Erreurs communes**: SC2086 (quoting), SC2034 (unused vars)
- **Plugin support**: Config options, ignore patterns
- **Management**: `scripts/linting/manager_shellcheck_plugin.sh`

### Architecture Modulaire par Linter

**Approach factĞ¾risÃ©e** :

```text
./linting/plugins.d/
â”œâ”€â”€ README.md                           # Overview des linters supportÃ©s
â”œâ”€â”€ scripts/linting/manager_markdownlint_plugin.sh      # Gestionnaire markdownlint
â”œâ”€â”€ scripts/linting/manager_prettier_plugin.sh          # Gestionnaire prettier
â”œâ”€â”€ scripts/linting/manager_codespell_plugin.sh         # Gestionnaire codespell
â”œâ”€â”€ scripts/linting/manager_shellcheck_plugin.sh        # Gestionnaire shellcheck
â”‚
â”œâ”€â”€ markdownlint/                       # Plugins markdownlint
â”‚   â”œâ”€â”€ md040-yaml-blocks/
â”‚   â”œâ”€â”€ md036-emphasis-headers/
â”‚   â””â”€â”€ md013-line-length/
â”‚
â”œâ”€â”€ prettier/                           # Plugins prettier
â”‚   â”œâ”€â”€ smart-line-breaks/
â”‚   â””â”€â”€ code-block-formatting/
â”‚
â”œâ”€â”€ codespell/                          # Plugins codespell
â”‚   â”œâ”€â”€ project-dictionary/
â”‚   â””â”€â”€ ignore-patterns/
â”‚
â””â”€â”€ shellcheck/                         # Plugins shellcheck
    â”œâ”€â”€ quoting-fixes/
    â””â”€â”€ variable-checks/
```

### Commandes UnifiÃ©es

**Interface standardisÃ©e** pour tous les linters :

```bash
# Pattern: ./manager_[LINTER]_plugin.sh [ACTION] [PLUGIN]

# Markdownlint
./scripts/linting/manager_markdownlint_plugin.sh --install md040-yaml-blocks
./scripts/linting/manager_markdownlint_plugin.sh --list
./scripts/linting/manager_markdownlint_plugin.sh --enable md036-emphasis-headers

# Prettier
./scripts/linting/manager_prettier_plugin.sh --install smart-line-breaks
./scripts/linting/manager_prettier_plugin.sh --disable code-formatting

# Codespell
./scripts/linting/manager_codespell_plugin.sh --install project-dictionary
./scripts/linting/manager_codespell_plugin.sh --status ignore-patterns

# ShellCheck
./scripts/linting/manager_shellcheck_plugin.sh --install quoting-fixes
```

### IntÃ©gration avec /dd:lint

**Syntax unifiÃ©e** avec prÃ©fixe linter :

```bash
# Linter-specific plugin management
/dd:lint --apply-plugin markdownlint:md040-yaml-blocks
/dd:lint --apply-plugin prettier:smart-line-breaks
/dd:lint --apply-plugin codespell:project-dictionary

# List all plugins across linters
/dd:lint --list-plugins
# Output:
# ğŸ“‹ Markdownlint:
#   âœ… md040-yaml-blocks - APPLIED
#   ğŸ’¡ md036-emphasis-headers - PROPOSED
# ğŸ“‹ Prettier:
#   âŒ smart-line-breaks - REFUSED
# ğŸ“‹ Codespell:
#   ğŸ’¡ project-dictionary - PROPOSED

# Suggest plugins based on error cache
/dd:lint --suggest-plugins
# Analyse .cache/linting/error-patterns.json
# Propose plugins pour patterns dÃ©tectÃ©s
```

### DÃ©tection Automatique des Linters

**Script de discovery** : `detect-available-linters.sh`

```bash
# Check available linters on system
./detect-available-linters.sh
# Output:
# âœ… markdownlint-cli  (v0.28.1) - manager available
# âœ… prettier         (v2.8.0)  - manager available
# âœ… codespell        (v2.2.1)  - manager available
# âŒ shellcheck       (not installed)
# âš ï¸  eslint          (v8.32.0) - manager not implemented
```

### Configuration par Project

**Fichier de config** : `./linting/linters-config.json`

```json
{
  "enabled_linters": ["markdownlint", "prettier", "codespell"],
  "linter_configs": {
    "markdownlint": {
      "config_file": ".markdownlint.json",
      "rules_dir": ".markdownlint/rules",
      "manager": "scripts/linting/manager_markdownlint_plugin.sh"
    },
    "prettier": {
      "config_file": ".prettierrc",
      "ignore_file": ".prettierignore",
      "manager": "scripts/linting/manager_prettier_plugin.sh"
    },
    "codespell": {
      "config_file": ".codespell.cfg",
      "dict_file": ".codespell-words.txt",
      "manager": "scripts/linting/manager_codespell_plugin.sh"
    }
  }
}
```

## Notes

Cette restructuration prÃ©pare le systÃ¨me pour les plugins intelligents prÃ©vus dans DD108, en fournissant les donnÃ©es
structurÃ©es nÃ©cessaires pour des suggestions prÃ©cises.

**Architecture modulaire** permet :

- ğŸ”§ **Linter-specific**: Chaque outil a sa gestion optimisÃ©e
- ğŸ“¦ **Modulaire**: SystÃ¨mes de plugins indÃ©pendants par linter
- ğŸ¤– **AI-driven**: Suggestions intelligentes basÃ©es sur patterns rÃ©els
- ğŸ”„ **Extensible**: Facile d'ajouter nouveaux linters
- âš™ï¸ **StandardisÃ©**: Interface commune pour tous les gestionnaires
